<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>学会用各种姿势备份MySQL数据库 | World of Forks</title>
  <meta name="description" content="A blog of Jason" />
  <meta name="keywords" content="blog,cjade,IT,Web,PHP,PHP框架,Python,Go,Golang,laravel,mysql,文档,教程,中文,资源,学习" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" href="/images/favicon.ico">
  <link rel="alternate" href="/atom.xml" title="World of Forks">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="前言 我们试着想一想, 在生产环境中什么最重要？如果我们服务器的硬件坏了可以维修或者换新, 软件问题可以修复或重新安装, 但是如果数据没了呢？这可能是最恐怖的事情了吧, 我感觉在生产环境中应该没有什么比数据跟更为重要. 那么我们该如何保证数据不丢失、或者丢失后可以快速恢复呢？只要看完这篇, 大家应该就能对MySQL中实现数据备份和恢复能有一定的了解。">
<meta name="keywords" content="mysql">
<meta property="og:type" content="article">
<meta property="og:title" content="学会用各种姿势备份MySQL数据库">
<meta property="og:url" content="http://www.mcoo.me/2017/06/06/学会用各种姿势备份MySQL数据库/index.html">
<meta property="og:site_name" content="World of Forks">
<meta property="og:description" content="前言 我们试着想一想, 在生产环境中什么最重要？如果我们服务器的硬件坏了可以维修或者换新, 软件问题可以修复或重新安装, 但是如果数据没了呢？这可能是最恐怖的事情了吧, 我感觉在生产环境中应该没有什么比数据跟更为重要. 那么我们该如何保证数据不丢失、或者丢失后可以快速恢复呢？只要看完这篇, 大家应该就能对MySQL中实现数据备份和恢复能有一定的了解。">
<meta property="og:updated_time" content="2017-06-06T07:38:49.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="学会用各种姿势备份MySQL数据库">
<meta name="twitter:description" content="前言 我们试着想一想, 在生产环境中什么最重要？如果我们服务器的硬件坏了可以维修或者换新, 软件问题可以修复或重新安装, 但是如果数据没了呢？这可能是最恐怖的事情了吧, 我感觉在生产环境中应该没有什么比数据跟更为重要. 那么我们该如何保证数据不丢失、或者丢失后可以快速恢复呢？只要看完这篇, 大家应该就能对MySQL中实现数据备份和恢复能有一定的了解。">
    
  <link href="https://fonts.googleapis.com/css?family=Inconsolata|Titillium+Web" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
  <link href='//cdn.bootcss.com/node-waves/0.7.5/waves.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="/style.css">
  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
</head>

<body>
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>


  <script>setLoadingBarProgress(20)</script> 
  <header class="l_header">
	<div class='wrapper'>
		<div class="nav-main container container--flex">
			<a class="logo flat-box" href='/'>
				World of Forks
			</a>
			<div class='menu'>
				<ul class='h-list'>
					
						<li>
							<a class='flat-box nav-home' href='/'>
								Home
							</a>
						</li>
						
						<li>
							<a class='flat-box nav-archives' href='/archives'>
								Archives
							</a>
						</li>
						
						<li>
							<a class='flat-box nav-gallery' href='https://photos.google.com/album/AF1QipNoqKYgspQo5O1YhlFXGCQ7p575KBH3Yxf8WHL4?hl=zh-CN'>
								Gallery
							</a>
						</li>
						
						<li>
							<a class='flat-box nav-about' href='/about'>
								About
							</a>
						</li>
						
				</ul>
				<div class='underline'></div>
			</div>
			<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=298 height=52 src="//music.163.com/outchain/player?type=2&id=432506809&auto=1&height=32"></iframe>
			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="Search" />
						<span class="icon icon-search"></span>
					</form>
				</div>
				
					<ul class='switcher h-list'>
						
							<li class='s-search'><a href='javascript:void(0)'><span class="icon icon-search flat-box"></span></a></li>
							
								<li class='s-menu'><a href='javascript:void(0)'><span class="icon icon-menu flat-box"></span></a></li>
					</ul>
		</div>

		<div class='nav-sub container container--flex'>
			<a class="logo" class="flat-box" href='javascript:void(0)'>
				Word of Forks
			</a>

			<ul class='switcher h-list'>
				<li class='s-comment'><a href='javascript:void(0)'><span class="icon icon-chat_bubble_outline flat-box"></span></a></li>
				<li class='s-top'><a href='javascript:void(0)'><span class="icon icon-arrow_upward flat-box"></span></a></li>
				<li class='s-toc'><a href='javascript:void(0)'><span class="icon icon-format_list_numbered flat-box"></span></a></li>
			</ul>
		</div>
	</div>
</header>
<aside class="menu-phone">
	<nav>
		
			<a href="/" class="nav-home nav">
				Home
			</a>
			
			<a href="/archives" class="nav-archives nav">
				Archives
			</a>
			
			<a href="https://photos.google.com/album/AF1QipNoqKYgspQo5O1YhlFXGCQ7p575KBH3Yxf8WHL4?hl=zh-CN" class="nav-gallery nav">
				Gallery
			</a>
			
			<a href="/about" class="nav-about nav">
				About
			</a>
			
	</nav>
</aside>

    <script>setLoadingBarProgress(40);</script>
  <div class="l_body">
    <div class='container clearfix'>
      <div class='l_main'>
        <article id="post-学会用各种姿势备份MySQL数据库" class="post white-box article-type-post" itemscope itemprop="blogPost">
    <section class='meta'>
        <h2 class="title">
  	<a href="/2017/06/06/学会用各种姿势备份MySQL数据库/">
    	学会用各种姿势备份MySQL数据库
    </a>
  </h2>
        <time>
	  6月 6, 2017
	</time>
        
    
    <div class='cats'>
        <a href="/categories/MySql/">MySql</a>
    </div>

    </section>
    
        <section class="toc-wrapper">
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#为什么需要备份数据？"><span class="toc-number">2.</span> <span class="toc-text">为什么需要备份数据？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据的备份类型"><span class="toc-number">3.</span> <span class="toc-text">数据的备份类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL备份数据的方式"><span class="toc-number">4.</span> <span class="toc-text">MySQL备份数据的方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#备份需要考虑的问题"><span class="toc-number">5.</span> <span class="toc-text">备份需要考虑的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#设计合适的备份策略"><span class="toc-number">6.</span> <span class="toc-text">设计合适的备份策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实战演练"><span class="toc-number">7.</span> <span class="toc-text">实战演练</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用cp进行备份"><span class="toc-number">7.1.</span> <span class="toc-text">使用cp进行备份</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用mysqldump-复制BINARY-LOG备份"><span class="toc-number">7.2.</span> <span class="toc-text">使用mysqldump+复制BINARY LOG备份</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用lvm2快照备份数据"><span class="toc-number">7.3.</span> <span class="toc-text">使用lvm2快照备份数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用Xtrabackup备份"><span class="toc-number">7.4.</span> <span class="toc-text">使用Xtrabackup备份</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">8.</span> <span class="toc-text">总结</span></a></li></ol>
        </section>
        
            <section class="article typo">
                <div class="article-entry" itemprop="articleBody">
                    <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p>我们试着想一想, 在生产环境中什么最重要？如果我们服务器的硬件坏了可以维修或者换新, 软件问题可以修复或重新安装, 但是如果数据没了呢？这可能是最恐怖的事情了吧, 我感觉在生产环境中应该没有什么比数据跟更为重要. 那么我们该如何保证数据不丢失、或者丢失后可以快速恢复呢？只要看完这篇, 大家应该就能对<code>MySQL</code>中实现数据备份和恢复能有一定的了解。</p>
</blockquote>
<a id="more"></a>
<h2 id="为什么需要备份数据？"><a href="#为什么需要备份数据？" class="headerlink" title="为什么需要备份数据？"></a>为什么需要备份数据？</h2><blockquote>
<p>其实在<code>前言</code>中也大概说明了为什么要备份数据, 但是我们还是应该具体了解一下为什么要备份数据</p>
<p>在生产环境中我们数据库可能会遭遇各种各样的不测从而导致数据丢失, 大概分为以下几种.</p>
<ul>
<li>硬件故障</li>
<li>软件故障</li>
<li>自然灾害</li>
<li>黑客攻击</li>
<li>误操作 (占比最大)</li>
</ul>
<p>所以, 为了在数据丢失之后能够恢复数据, 我们就需要定期的备份数据, 备份数据的策略要根据不同的应用场景进行定制, 大致有几个参考数值, 我们可以根据这些数值从而定制符合特定环境中的数据备份策略</p>
<ul>
<li>能够容忍丢失多少数据</li>
<li>恢复数据需要多长时间</li>
<li>需要恢复哪一些数据</li>
</ul>
</blockquote>
<h2 id="数据的备份类型"><a href="#数据的备份类型" class="headerlink" title="数据的备份类型"></a>数据的备份类型</h2><blockquote>
<p>数据的备份类型根据其自身的特性主要分为以下几组</p>
<ul>
<li><p>完全备份</p>
</li>
<li><p>部分备份</p>
<p>完全备份指的是<strong>备份整个数据集( 即整个数据库 )</strong>、部分备份指的是<strong>备份部分数据集(例如: 只备份一个表)</strong></p>
</li>
</ul>
<p>而部分备份又分为以下两种</p>
<ul>
<li><p>增量备份</p>
</li>
<li><p>差异备份</p>
<p>增量备份指的是<strong>备份自上一次备份以来(增量或完全)以来变化的数据</strong>; 特点: 节约空间、还原麻烦<br>差异备份指的是<strong>备份自上一次完全备份以来变化的数据</strong> 特点: 浪费空间、还原比增量备份简单</p>
</li>
</ul>
<p>示意图</p>
</blockquote>
<h2 id="MySQL备份数据的方式"><a href="#MySQL备份数据的方式" class="headerlink" title="MySQL备份数据的方式"></a><strong>MySQL备份数据的方式</strong></h2><blockquote>
<p>在<code>MySQl</code>中我们备份数据一般有几种方式</p>
<ul>
<li><p>热备份</p>
</li>
<li><p>温备份</p>
</li>
<li><p>冷备份</p>
<p>热备份指的是当数据库进行备份时, <strong>数据库的读写操作均不是受影响 </strong><br>温备份指的是当数据库进行备份时, <strong>数据库的读操作可以执行, 但是不能执行写操作</strong><br>冷备份指的是当数据库进行备份时, <strong>数据库不能进行读写操作, 即数据库要下线</strong></p>
</li>
</ul>
<p><code>MySQL</code>中进行不同方式的备份还要考虑存储引擎是否支持</p>
<ul>
<li><p>MyISAM </p>
<p> 热备 ×</p>
<p> 温备 √</p>
<p> 冷备 √</p>
</li>
<li><p>InnoDB</p>
<p> 热备 √</p>
<p> 温备 √</p>
<p> 冷备 √</p>
<p>我们在考虑完数据在备份时, 数据库的运行状态之后还需要考虑对于<code>MySQL</code>数据库中数据的备份方式</p>
<p>物理备份一般就是<strong>通过**</strong>tar,cp等命令直接打包复制数据库的数据文件<strong>达到备份的效果<br>逻辑备份一般就是</strong>通过特定工具从数据库中导出数据并另存备份**(逻辑备份会丢失数据精度)</p>
</li>
<li><ul>
<li>物理备份</li>
<li>逻辑备份</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="备份需要考虑的问题"><a href="#备份需要考虑的问题" class="headerlink" title="备份需要考虑的问题"></a>备份需要考虑的问题</h2><blockquote>
<p>定制备份策略前, 我们还需要考虑一些问题</p>
<p><strong>我们要备份什么?</strong></p>
<p>一般情况下, 我们需要备份的数据分为以下几种</p>
<ul>
<li>数据</li>
<li>二进制日志, InnoDB事务日志</li>
<li>代码(存储过程、存储函数、触发器、事件调度器)</li>
<li>服务器配置文件</li>
</ul>
<p><strong>备份工具</strong></p>
<p>这里我们列举出常用的几种备份工具<br><code>mysqldump</code> : 逻辑备份工具, 适用于所有的存储引擎, 支持温备、完全备份、部分备份、对于<strong>InnoDB</strong>存储引擎支持热备<br><code>cp, tar 等归档复制工具</code>: 物理备份工具, 适用于所有的存储引擎, 冷备、完全备份、部分备份<br><code>lvm2 snapshot</code>: 几乎热备, 借助文件系统管理工具进行备份<br><code>mysqlhotcopy</code>: 名不副实的的一个工具, 几乎冷备, 仅支持<strong>MyISAM</strong>存储引擎<br><code>xtrabackup</code>: 一款非常强大的<strong>InnoDB/XtraDB</strong>热备工具, 支持完全备份、增量备份, 由<code>percona</code>提供</p>
</blockquote>
<h2 id="设计合适的备份策略"><a href="#设计合适的备份策略" class="headerlink" title="设计合适的备份策略"></a>设计合适的备份策略</h2><blockquote>
<p>针对不同的场景下, 我们应该制定不同的备份策略对数据库进行备份, 一般情况下, 备份策略一般为以下三种</p>
<ul>
<li><strong>直接cp,tar复制数据库文件</strong></li>
<li><strong>mysqldump+复制BIN LOGS</strong></li>
<li><strong>lvm2快照+复制BIN LOGS</strong></li>
<li><strong>xtrabackup</strong></li>
</ul>
<p>以上的几种解决方案分别针对于不同的场景</p>
<ol>
<li>如果数据量较小, 可以使用第一种方式, 直接复制数据库文件</li>
<li>如果数据量还行, 可以使用第二种方式, 先使用mysqldump对数据库进行完全备份, 然后定期备份BINARY LOG达到增量备份的效果</li>
<li>如果数据量一般, 而又不过分影响业务运行, 可以使用第三种方式, 使用<code>lvm2</code>的快照对数据文件进行备份, 而后定期备份BINARY LOG达到增量备份的效果</li>
<li>如果数据量很大, 而又不过分影响业务运行, 可以使用第四种方式, 使用<code>xtrabackup</code>进行完全备份后, 定期使用<code>xtrabackup</code>进行增量备份或差异备份</li>
</ol>
</blockquote>
<h2 id="实战演练"><a href="#实战演练" class="headerlink" title="实战演练"></a>实战演练</h2><h3 id="使用cp进行备份"><a href="#使用cp进行备份" class="headerlink" title="使用cp进行备份"></a>使用cp进行备份</h3><blockquote>
<p>我们这里使用的是使用yum安装的<code>mysql-5.1</code>的版本, 使用的数据集为从网络上找到的一个员工数据库</p>
</blockquote>
<p><strong>查看数据库的信息</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SHOW DATABASES;    #查看当前的数据库, 我们的数据库为employees</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| employees          |</div><div class="line">| mysql              |</div><div class="line">| test               |</div><div class="line">+--------------------+</div><div class="line">4 rows in set (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; USE employees;</div><div class="line">Database changed</div><div class="line">mysql&gt; SHOW TABLES;         #查看当前库中的表</div><div class="line">+---------------------+</div><div class="line">| Tables_in_employees |</div><div class="line">+---------------------+</div><div class="line">| departments         |</div><div class="line">| dept_emp            |</div><div class="line">| dept_manager        |</div><div class="line">| employees           |</div><div class="line">| salaries            |</div><div class="line">| titles              |</div><div class="line">+---------------------+</div><div class="line">6 rows in set (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; SELECT COUNT(*) FROM employees;   #由于篇幅原因, 我们这里只看一下employees的行数为300024</div><div class="line">+----------+</div><div class="line">| COUNT(*) |</div><div class="line">+----------+</div><div class="line">|   300024 |</div><div class="line">+----------+</div><div class="line">1 row in set (0.05 sec)</div></pre></td></tr></table></figure>
<p><strong>向数据库施加读锁</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; FLUSH TABLES WITH READ LOCK;    #向所有表施加读锁</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div></pre></td></tr></table></figure>
<p><strong>备份数据文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]# mkdir /backup   #创建文件夹存放备份数据库文件</div><div class="line">[root@node1 ~]# cp -a /var/lib/mysql/* /backup     #保留权限的拷贝源数据文件</div><div class="line">[root@node1 ~]# ls /backup   #查看目录下的文件</div><div class="line">employees  ibdata1  ib_logfile0  ib_logfile1  mysql  mysql.sock  test</div></pre></td></tr></table></figure>
<p><strong>模拟数据丢失并恢复</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]# rm -rf /var/lib/mysql/*    #删除数据库的所有文件</div><div class="line">[root@node1 ~]# service mysqld restart   #重启MySQL, 如果是编译安装的应该不能启动, 如果rpm安装则会重新初始化数据库</div><div class="line"></div><div class="line"></div><div class="line">mysql&gt; SHOW DATABASES;    #因为我们是rpm安装的, 连接到MySQL进行查看, 发现数据丢失了！</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| mysql              |</div><div class="line">| test               |</div><div class="line">+--------------------+</div><div class="line">3 rows in set (0.00 sec)</div><div class="line"></div><div class="line">[root@node1 ~]# rm -rf /var/lib/mysql/*    #这一步可以不做</div><div class="line">[root@node1 ~]# cp -a /backup/* /var/lib/mysql/    #将备份的数据文件拷贝回去</div><div class="line">[root@node1 ~]# service mysqld restart  #重启MySQL</div><div class="line"></div><div class="line"></div><div class="line">#重新连接数据并查看</div><div class="line"></div><div class="line">mysql&gt; SHOW DATABASES;    #数据库已恢复</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| employees          |</div><div class="line">| mysql              |</div><div class="line">| test               |</div><div class="line">+--------------------+</div><div class="line">4 rows in set (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; USE employees;      </div><div class="line"></div><div class="line">mysql&gt; SELECT COUNT(*) FROM employees;    #表的行数没有变化</div><div class="line">+----------+</div><div class="line">| COUNT(*) |</div><div class="line">+----------+</div><div class="line">|   300024 |</div><div class="line">+----------+</div><div class="line">1 row in set (0.06 sec)</div><div class="line"></div><div class="line"></div><div class="line">##完成</div></pre></td></tr></table></figure>
<h3 id="使用mysqldump-复制BINARY-LOG备份"><a href="#使用mysqldump-复制BINARY-LOG备份" class="headerlink" title="使用mysqldump+复制BINARY LOG备份"></a>使用mysqldump+复制BINARY LOG备份</h3><blockquote>
<p>我们这里使用的是使用yum安装的<code>mysql-5.1</code>的版本, 使用的数据集为从网络上找到的一个员工数据库</p>
<p>我们通过mysqldump进行一次完全备份, 再修改表中的数据, 然后再通过binary log进行恢复 <strong>二进制日志需要在mysql配置文件中添加 log_bin=on 开启</strong></p>
</blockquote>
<p><strong>mysqldump命令介绍</strong></p>
<blockquote>
<p><code>mysqldump</code>是一个客户端的逻辑备份工具, 可以生成一个重现创建原始数据库和表的SQL语句, 可以支持所有的存储引擎, 对于InnoDB支持热备</p>
<p><a href="http://dev.mysql.com/doc/refman/5.7/en/mysqldump.html" target="_blank" rel="external">官方文档介绍</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">#基本语法格式</div><div class="line"></div><div class="line">shell&gt; mysqldump [options] db_name [tbl_name ...]    恢复需要手动CRATE DATABASES</div><div class="line">shell&gt; mysqldump [options] --databases db_name ...   恢复不需要手动创建数据库</div><div class="line">shell&gt; mysqldump [options] --all-databases           恢复不需要手动创建数据库</div><div class="line"></div><div class="line"></div><div class="line">其他选项:</div><div class="line">     -E, --events: 备份事件调度器</div><div class="line">     -R, --routines: 备份存储过程和存储函数</div><div class="line">     --triggers: 备份表的触发器; --skip-triggers </div><div class="line">     --master-date[=value]  </div><div class="line">         1: 记录为CHANGE MASTER TO 语句、语句不被注释</div><div class="line">         2: 记录为注释的CHANGE MASTER TO语句</div><div class="line">         基于二进制还原只能全库还原</div><div class="line"></div><div class="line">     --flush-logs: 日志滚动</div><div class="line">         锁定表完成后执行日志滚动</div></pre></td></tr></table></figure>
<p><strong>查看数据库的信息</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SHOW DATABASES;    #查看当前的数据库, 我们的数据库为employees</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| employees          |</div><div class="line">| mysql              |</div><div class="line">| test               |</div><div class="line">+--------------------+</div><div class="line">4 rows in set (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; USE employees;</div><div class="line">Database changed</div><div class="line">mysql&gt; SHOW TABLES;         #查看当前库中的表</div><div class="line">+---------------------+</div><div class="line">| Tables_in_employees |</div><div class="line">+---------------------+</div><div class="line">| departments         |</div><div class="line">| dept_emp            |</div><div class="line">| dept_manager        |</div><div class="line">| employees           |</div><div class="line">| salaries            |</div><div class="line">| titles              |</div><div class="line">+---------------------+</div><div class="line">6 rows in set (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; SELECT COUNT(*) FROM employees;   #由于篇幅原因, 我们这里只看一下employees的行数为300024</div><div class="line">+----------+</div><div class="line">| COUNT(*) |</div><div class="line">+----------+</div><div class="line">|   300024 |</div><div class="line">+----------+</div><div class="line">1 row in set (0.05 sec)</div></pre></td></tr></table></figure>
<p><strong>使用mysqldump备份数据库</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]# mysql -e &apos;SHOW MASTER STATUS&apos;   #查看当前二进制文件的状态, 并记录下position的数字</div><div class="line">+------------------+----------+--------------+------------------+</div><div class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |</div><div class="line">+------------------+----------+--------------+------------------+</div><div class="line">| mysql-bin.000003 |      106 |              |                  |</div><div class="line">+------------------+----------+--------------+------------------+</div><div class="line"></div><div class="line">[root@node1 ~]# mysqldump --all-databases --lock-all-tables  &gt; backup.sql   #备份数据库到backup.sql文件中</div><div class="line"></div><div class="line">mysql&gt; CREATE DATABASE TEST1;   #创建一个数据库</div><div class="line">Query OK, 1 row affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; SHOW MASTER STATUS;   #记下现在的position</div><div class="line">+------------------+----------+--------------+------------------+</div><div class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |</div><div class="line">+------------------+----------+--------------+------------------+</div><div class="line">| mysql-bin.000003 |      191 |              |                  |</div><div class="line">+------------------+----------+--------------+------------------+</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line">[root@node1 ~]# cp /var/lib/mysql/mysql-bin.000003 /root  #备份二进制文件</div><div class="line">[root@node1 ~]# service mysqld stop   #停止MySQL</div><div class="line">[root@node1 ~]# rm -rf /var/lib/mysql/*   #删除所有的数据文件</div><div class="line">[root@node1 ~]# service mysqld start    #启动MySQL, 如果是编译安装的应该不能启动(需重新初始化), 如果rpm安装则会重新初始化数据库</div><div class="line"></div><div class="line"></div><div class="line">mysql&gt; SHOW DATABASES;   #查看数据库, 数据丢失!</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| mysql              |</div><div class="line">| test               |</div><div class="line">+--------------------+</div><div class="line">3 rows in set (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; SET sql_log_bin=OFF;   #暂时先将二进制日志关闭  </div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line"></div><div class="line">mysql&gt; source backup.sql  #恢复数据，所需时间根据数据库时间大小而定</div><div class="line"></div><div class="line">mysql&gt; SET sql_log_bin=ON; 开启二进制日志</div><div class="line"></div><div class="line">mysql&gt; SHOW DATABASES;   #数据库恢复, 但是缺少TEST1</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| employees          |</div><div class="line">| mysql              |</div><div class="line">| test               |</div><div class="line">+--------------------+</div><div class="line">4 rows in set (0.00 sec)</div><div class="line"></div><div class="line">[root@node1 ~]# mysqlbinlog --start-position=106 --stop-position=191 mysql-bin.000003 | mysql employees #通过二进制日志增量恢复数据</div><div class="line"></div><div class="line">mysql&gt; SHOW DATABASES;    #现在TEST1出现了！</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| TEST1              |</div><div class="line">| employees          |</div><div class="line">| mysql              |</div><div class="line">| test               |</div><div class="line">+--------------------+</div><div class="line">5 rows in set (0.00 sec)</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">#完成</div></pre></td></tr></table></figure>
<h3 id="使用lvm2快照备份数据"><a href="#使用lvm2快照备份数据" class="headerlink" title="使用lvm2快照备份数据"></a>使用lvm2快照备份数据</h3><blockquote>
<p>做实验之前我们先回顾一下<code>lvm2-snapshot</code>的知识</p>
<p><code>LVM</code>快照简单来说就是将所快照源分区一个时间点所有文件的元数据进行保存，如果源文件没有改变，那么访问快照卷的相应文件则直接指向源分区的源文件，如果源文件发生改变，则快照卷中与之对应的文件不会发生改变。快照卷主要用于辅助备份文件。 这里只简单介绍，<a href="http://www.360doc.com/content/13/0522/16/11801283_287305129.shtml" target="_blank" rel="external">点击查看详细介绍</a></p>
</blockquote>
<p><strong>部署lvm环境</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line">添加硬盘; 这里我们直接实现SCSI硬盘的热插拔, 首先在虚拟机中添加一块硬盘, 不重启</div><div class="line"></div><div class="line">[root@node1 ~]# ls /dev/sd*   #只有以下几块硬盘, 但是我们不重启可以让系统识别新添加的硬盘</div><div class="line">/dev/sda  /dev/sda1  /dev/sda2</div><div class="line"></div><div class="line">[root@node1 ~]# echo &apos;- - -&apos; &gt; /sys/class/scsi_host/host0/scan </div><div class="line">[root@node1 ~]# echo &apos;- - -&apos; &gt; /sys/class/scsi_host/host1/scan </div><div class="line">[root@node1 ~]# echo &apos;- - -&apos; &gt; /sys/class/scsi_host/host2/scan </div><div class="line"></div><div class="line">[root@node1 ~]# ls /dev/sd*    #看！sdb识别出来了</div><div class="line">/dev/sda  /dev/sda1  /dev/sda2  /dev/sdb</div><div class="line"></div><div class="line"></div><div class="line">[root@node1 ~]# fdisk /dev/sdb   #分区</div><div class="line">Device contains neither a valid DOS partition table, nor Sun, SGI or OSF disklabel</div><div class="line">Building a new DOS disklabel with disk identifier 0xd353d192.</div><div class="line">Changes will remain in memory only, until you decide to write them.</div><div class="line">After that, of course, the previous content won&apos;t be recoverable.</div><div class="line"></div><div class="line">Warning: invalid flag 0x0000 of partition table 4 will be corrected by w(rite)</div><div class="line"></div><div class="line">WARNING: DOS-compatible mode is deprecated. It&apos;s strongly recommended to</div><div class="line">         switch off the mode (command &apos;c&apos;) and change display units to</div><div class="line">         sectors (command &apos;u&apos;).</div><div class="line"></div><div class="line">Command (m for help): n</div><div class="line">Command action</div><div class="line">   e   extended</div><div class="line">   p   primary partition (1-4)</div><div class="line">p</div><div class="line">Partition number (1-4): 1</div><div class="line">First cylinder (1-2610, default 1): </div><div class="line">Using default value 1</div><div class="line">Last cylinder, +cylinders or +size&#123;K,M,G&#125; (1-2610, default 2610): +15G</div><div class="line"></div><div class="line">Command (m for help): t</div><div class="line">Selected partition 1</div><div class="line">Hex code (type L to list codes): 8e</div><div class="line">Changed system type of partition 1 to 8e (Linux LVM)</div><div class="line"></div><div class="line">Command (m for help): w</div><div class="line">The partition table has been altered!</div><div class="line"></div><div class="line">Calling ioctl() to re-read partition table.</div><div class="line">Syncing disks.</div><div class="line">You have new mail in /var/spool/mail/root</div><div class="line">[root@node1 ~]# partx -a /dev/sdb</div><div class="line">BLKPG: Device or resource busy</div><div class="line">error adding partition 1</div><div class="line"></div><div class="line">##创建逻辑卷</div><div class="line">[root@node1 ~]# pvcreate /dev/sdb1</div><div class="line">  Physical volume &quot;/dev/sdb1&quot; successfully created</div><div class="line">[root@node1 ~]# vgcreate myvg /dev/sdb1 </div><div class="line">  Volume group &quot;myvg&quot; successfully created</div><div class="line">[root@node1 ~]# lvcreate -n mydata -L 5G myvg </div><div class="line">  Logical volume &quot;mydata&quot; created.</div><div class="line"></div><div class="line">[root@node1 ~]# mkfs.ext4 /dev/mapper/myvg-mydata   #格式化</div><div class="line">[root@node1 ~]# mkdir /lvm_data</div><div class="line">[root@node1 ~]# mount /dev/mapper/myvg-mydata /lvm_data  #挂载到/lvm_data</div><div class="line"></div><div class="line"></div><div class="line">[root@node1 ~]# vim /etc/my.cnf    #修改mysql配置文件的datadir如下</div><div class="line"></div><div class="line">datadir=/lvm_data</div><div class="line"></div><div class="line">[root@node1 ~]# service mysqld restart  #重启MySQL</div><div class="line"></div><div class="line">####重新导入employees数据库########略过####</div></pre></td></tr></table></figure>
<p><strong>查看数据库的信息</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SHOW DATABASES;    #查看当前的数据库, 我们的数据库为employees</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| employees          |</div><div class="line">| mysql              |</div><div class="line">| test               |</div><div class="line">+--------------------+</div><div class="line">4 rows in set (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; USE employees;</div><div class="line">Database changed</div><div class="line">mysql&gt; SHOW TABLES;         #查看当前库中的表</div><div class="line">+---------------------+</div><div class="line">| Tables_in_employees |</div><div class="line">+---------------------+</div><div class="line">| departments         |</div><div class="line">| dept_emp            |</div><div class="line">| dept_manager        |</div><div class="line">| employees           |</div><div class="line">| salaries            |</div><div class="line">| titles              |</div><div class="line">+---------------------+</div><div class="line">6 rows in set (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; SELECT COUNT(*) FROM employees;   #由于篇幅原因, 我们这里只看一下employees的行数为300024</div><div class="line">+----------+</div><div class="line">| COUNT(*) |</div><div class="line">+----------+</div><div class="line">|   300024 |</div><div class="line">+----------+</div><div class="line">1 row in set (0.05 sec)</div></pre></td></tr></table></figure>
<p><strong>创建快照卷并备份</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">mysql&gt; FLUSH TABLES WITH READ LOCK;     #锁定所有表</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">[root@node1 lvm_data]# lvcreate -L 1G -n mydata-snap -p r -s /dev/mapper/myvg-mydata   #创建快照卷</div><div class="line">  Logical volume &quot;mydata-snap&quot; created.</div><div class="line"></div><div class="line">mysql&gt; UNLOCK TABLES;  #解锁所有表</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">[root@node1 lvm_data]# mkdir /lvm_snap  #创建文件夹</div><div class="line">[root@node1 lvm_data]# mount /dev/myvg/mydata-snap /lvm_snap/  #挂载snap</div><div class="line">mount: block device /dev/mapper/myvg-mydata--snap is write-protected, mounting read-only</div><div class="line"></div><div class="line">[root@node1 lvm_data]# cd /lvm_snap/</div><div class="line">[root@node1 lvm_snap]# ls</div><div class="line">employees  ibdata1  ib_logfile0  ib_logfile1  mysql  mysql-bin.000001  mysql-bin.000002  mysql-bin.000003  mysql-bin.index  test</div><div class="line">[root@node1 lvm_snap]# tar cf /tmp/mysqlback.tar *  #打包文件到/tmp/mysqlback.tar</div><div class="line"></div><div class="line">[root@node1 ~]# umount /lvm_snap/  #卸载snap</div><div class="line">[root@node1 ~]# lvremove myvg mydata-snap  #删除snap</div></pre></td></tr></table></figure>
<p><strong>恢复数据</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">[root@node1 lvm_snap]# rm -rf /lvm_data/*</div><div class="line">[root@node1 ~]# service mysqld start    #启动MySQL, 如果是编译安装的应该不能启动(需重新初始化), 如果rpm安装则会重新初始化数据库</div><div class="line"></div><div class="line"></div><div class="line">mysql&gt; SHOW DATABASES;   #查看数据库, 数据丢失!</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| mysql              |</div><div class="line">| test               |</div><div class="line">+--------------------+</div><div class="line">3 rows in set (0.00 sec)</div><div class="line"></div><div class="line">[root@node1 ~]# cd /lvm_data/</div><div class="line">[root@node1 lvm_data]# rm -rf * #删除所有文件</div><div class="line">[root@node1 lvm_data]# tar xf /tmp/mysqlback.tar     #解压备份数据库到此文件夹 </div><div class="line">[root@node1 lvm_data]# ls  #查看当前的文件</div><div class="line">employees  ibdata1  ib_logfile0  ib_logfile1  mysql  mysql-bin.000001  mysql-bin.000002  mysql-bin.000003  mysql-bin.index  test</div><div class="line"></div><div class="line">mysql&gt; SHOW DATABASES;  #数据恢复了</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| employees          |</div><div class="line">| mysql              |</div><div class="line">| test               |</div><div class="line">+--------------------+</div><div class="line">4 rows in set (0.00 sec)</div><div class="line"></div><div class="line"></div><div class="line">##完成</div></pre></td></tr></table></figure>
<h3 id="使用Xtrabackup备份"><a href="#使用Xtrabackup备份" class="headerlink" title="使用Xtrabackup备份"></a>使用Xtrabackup备份</h3><blockquote>
<p>为了更好地演示, 我们这次使用<code>mariadb-5.5</code>的版本, 使用<code>xtrabackup</code>使用InnoDB能够发挥其最大功效, 并且InnoDB的每一张表必须使用单独的表空间, 我们需要在配置文件中添加 <code>innodb_file_per_table = ON</code> 来开启</p>
</blockquote>
<p><strong>下载安装xtrabackup</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">我们这里通过wget percona官方的rpm包进行安装</div><div class="line">[root@node1 ~]# wget https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.3.4/binary/redhat/6/x86_64/percona-xtrabackup-2.3.4-1.el6.x86_64.rpm   </div><div class="line">[root@node1 ~]# yum localinstall percona-xtrabackup-2.3.4-1.el6.x86_64.rpm   #需要EPEL源</div></pre></td></tr></table></figure>
<p><strong>xtrabackup介绍</strong></p>
<blockquote>
<p><code>Xtrabackup</code>是由<code>percona</code>提供的<code>mysql</code>数据库备份工具，据官方介绍，这也是世界上惟一一款开源的能够对innodb和xtradb数据库进行热备的工具。特点：</p>
<ol>
<li>备份过程快速、可靠；</li>
<li>备份过程不会打断正在执行的事务；</li>
<li>能够基于压缩等功能节约磁盘空间和流量；</li>
<li>自动实现备份检验；</li>
<li>还原速度快；</li>
</ol>
<p><strong>摘自马哥的文档</strong></p>
</blockquote>
<p><strong>xtrabackup实现完全备份</strong></p>
<blockquote>
<p>我们这里使用<code>xtrabackup</code>的前端配置工具<code>innobackupex</code>来实现对数据库的完全备份</p>
<p>使用<code>innobackupex</code>备份时, 会调用<code>xtrabackup</code>备份所有的<strong>InnoDB</strong>表, 复制所有关于表结构定义的相关文件(.frm)、以及<strong>MyISAM</strong>、<strong>MERGE</strong>、<strong>CSV</strong>和<strong>ARCHIVE</strong>表的相关文件, 同时还会备份触发器和数据库配置文件信息相关的文件, 这些文件会被保存至一个以时间命名的目录.</p>
</blockquote>
<p><strong>备份过程</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]# mkdir /extrabackup  #创建备份目录</div><div class="line">[root@node1 ~]# innobackupex --user=root /extrabackup/ #备份数据</div><div class="line">###################提示complete表示成功*********************</div><div class="line"></div><div class="line">[root@node1 ~]# ls /extrabackup/  #看到备份目录</div><div class="line">2016-04-27_07-30-48</div></pre></td></tr></table></figure>
<blockquote>
<p>一般情况, 备份完成后, 数据不能用于恢复操作, 因为备份的数据中可能会包含尚未提交的事务或已经提交但尚未同步至数据文件中的事务。因此, 此时的数据文件仍不一致, 所以我们需要”准备”一个完全备份</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]# innobackupex --apply-log /extrabackup/2016-04-27_07-30-48/  #指定备份文件的目录</div><div class="line"></div><div class="line">#一般情况下下面三行结尾代表成功*****************</div><div class="line">InnoDB: Starting shutdown...</div><div class="line">InnoDB: Shutdown completed; log sequence number 369661462</div><div class="line">160427 07:40:11 completed OK!</div><div class="line"></div><div class="line">[root@node1 ~]# cd /extrabackup/2016-04-27_07-30-48/</div><div class="line">[root@node1 2016-04-27_07-30-48]# ls -hl  #查看备份文件</div><div class="line">total 31M</div><div class="line">-rw-r----- 1 root root  386 Apr 27 07:30 backup-my.cnf</div><div class="line">drwx------ 2 root root 4.0K Apr 27 07:30 employees</div><div class="line">-rw-r----- 1 root root  18M Apr 27 07:40 ibdata1</div><div class="line">-rw-r--r-- 1 root root 5.0M Apr 27 07:40 ib_logfile0</div><div class="line">-rw-r--r-- 1 root root 5.0M Apr 27 07:40 ib_logfile1</div><div class="line">drwx------ 2 root root 4.0K Apr 27 07:30 mysql</div><div class="line">drwx------ 2 root root 4.0K Apr 27 07:30 performance_schema</div><div class="line">drwx------ 2 root root 4.0K Apr 27 07:30 test</div><div class="line">-rw-r----- 1 root root   27 Apr 27 07:30 xtrabackup_binlog_info</div><div class="line">-rw-r--r-- 1 root root   29 Apr 27 07:40 xtrabackup_binlog_pos_innodb</div><div class="line">-rw-r----- 1 root root  117 Apr 27 07:40 xtrabackup_checkpoints</div><div class="line">-rw-r----- 1 root root  470 Apr 27 07:30 xtrabackup_info</div><div class="line">-rw-r----- 1 root root 2.0M Apr 27 07:40 xtrabackup_logfile</div></pre></td></tr></table></figure>
<p><strong>恢复数据</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]# rm -rf /data/*   #删除数据文件</div><div class="line"></div><div class="line">***不用启动数据库也可以还原*************</div><div class="line"></div><div class="line">[root@node1 ~]# innobackupex --copy-back /extrabackup/2016-04-27_07-30-48/   #恢复数据, 记清使用方法</div><div class="line"></div><div class="line">#########我们这里是编译安装的mariadb所以需要做一些操作##########</div><div class="line">[root@node1 data]# killall mysqld</div><div class="line"></div><div class="line">[root@node1 ~]# chown -R mysql:mysql ./* </div><div class="line">[root@node1 ~]# ll /data/      #数据恢复</div><div class="line">total 28704</div><div class="line">-rw-rw---- 1 mysql mysql    16384 Apr 27 07:43 aria_log.00000001</div><div class="line">-rw-rw---- 1 mysql mysql       52 Apr 27 07:43 aria_log_control</div><div class="line">-rw-rw---- 1 mysql mysql 18874368 Apr 27 07:43 ibdata1</div><div class="line">-rw-rw---- 1 mysql mysql  5242880 Apr 27 07:43 ib_logfile0</div><div class="line">-rw-rw---- 1 mysql mysql  5242880 Apr 27 07:43 ib_logfile1</div><div class="line">-rw-rw---- 1 mysql mysql      264 Apr 27 07:43 mysql-bin.000001</div><div class="line">-rw-rw---- 1 mysql mysql       19 Apr 27 07:43 mysql-bin.index</div><div class="line">-rw-r----- 1 mysql mysql     2166 Apr 27 07:43 node1.anyisalin.com.err</div><div class="line"></div><div class="line"></div><div class="line">[root@node1 data]# service mysqld restart</div><div class="line">MySQL server PID file could not be found!                  [FAILED]</div><div class="line">Starting MySQL..                                           [  OK  ]</div><div class="line"></div><div class="line">MariaDB [(none)]&gt; SHOW DATABASES;  #查看数据库, 已经恢复</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| employees          |</div><div class="line">| mysql              |</div><div class="line">| performance_schema |</div><div class="line">| test               |</div><div class="line">+--------------------+</div><div class="line">5 rows in set (0.00 sec</div></pre></td></tr></table></figure>
<p><strong>增量备份</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">#########创建连两个数据库以供测试#####################</div><div class="line">MariaDB [(none)]&gt; CREATE DATABASE TEST1;</div><div class="line">Query OK, 1 row affected (0.00 sec)</div><div class="line"></div><div class="line">MariaDB [(none)]&gt; CREATE DATABASE TEST2;</div><div class="line">Query OK, 1 row affected (0.00 sec)</div><div class="line"></div><div class="line">[root@node1 ~]# innobackupex --incremental /extrabackup/ --incremental-basedir=/extrabackup/2016-04-27_07-30-48/ </div><div class="line"></div><div class="line">[root@node1 ~]# ls /extrabackup/2016-04-27_07-57-22/ #查看备份文件</div><div class="line">total 96</div><div class="line">-rw-r----- 1 root root   386 Apr 27 07:57 backup-my.cnf</div><div class="line">drwx------ 2 root root  4096 Apr 27 07:57 employees</div><div class="line">-rw-r----- 1 root root 49152 Apr 27 07:57 ibdata1.delta</div><div class="line">-rw-r----- 1 root root    44 Apr 27 07:57 ibdata1.meta</div><div class="line">drwx------ 2 root root  4096 Apr 27 07:57 mysql</div><div class="line">drwx------ 2 root root  4096 Apr 27 07:57 performance_schema</div><div class="line">drwx------ 2 root root  4096 Apr 27 07:57 test</div><div class="line">drwx------ 2 root root  4096 Apr 27 07:57 TEST1</div><div class="line">drwx------ 2 root root  4096 Apr 27 07:57 TEST2</div><div class="line">-rw-r----- 1 root root    21 Apr 27 07:57 xtrabackup_binlog_info</div><div class="line">-rw-r----- 1 root root   123 Apr 27 07:57 xtrabackup_checkpoints</div><div class="line">-rw-r----- 1 root root   530 Apr 27 07:57 xtrabackup_info</div><div class="line">-rw-r----- 1 root root  2560 Apr 27 07:57 xtrabackup_logfile</div></pre></td></tr></table></figure>
<blockquote>
<p>BASEDIR指的是完全备份所在的目录，此命令执行结束后，<code>innobackupex</code>命令会在<code>/extrabackup</code>目录中创建一个新的以时间命名的目录以存放所有的增量备份数据。另外，在执行过增量备份之后再一次进行增量备份时，其<code>--incremental-basedir</code>应该指向上一次的增量备份所在的目录。</p>
<p>需要注意的是，增量备份仅能应用于InnoDB或XtraDB表，对于MyISAM表而言，执行增量备份时其实进行的是完全备份。</p>
</blockquote>
<p><strong>整理增量备份</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]# innobackupex --apply-log --redo-only /extrabackup/2016-04-27_07-30-48/</div><div class="line">[root@node1 ~]# innobackupex --apply-log --redo-only /extrabackup/2016-04-27_07-30-48/ --incremental-dir=/extrabackup/2016-04-27_07-5</div><div class="line">7-22/</div></pre></td></tr></table></figure>
<p><strong>恢复数据</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]# rm -rf /data/*   #删除数据</div><div class="line"></div><div class="line">[root@node1 ~]# innobackupex --copy-back /extrabackup/2016-04-27_07-30-48/     #整理增量备份之后可以直接通过全量备份还原</div><div class="line"></div><div class="line">[root@node1 ~]# chown -R mysql.mysql /data/</div><div class="line">[root@node1 ~]# ls /data/ -l</div><div class="line">total 28732</div><div class="line">-rw-rw---- 1 mysql mysql     8192 Apr 27 08:05 aria_log.00000001</div><div class="line">-rw-rw---- 1 mysql mysql       52 Apr 27 08:05 aria_log_control</div><div class="line">drwx------ 2 mysql mysql     4096 Apr 27 08:05 employees</div><div class="line">-rw-r----- 1 mysql mysql 18874368 Apr 27 08:05 ibdata1</div><div class="line">-rw-r----- 1 mysql mysql  5242880 Apr 27 08:05 ib_logfile0</div><div class="line">-rw-r----- 1 mysql mysql  5242880 Apr 27 08:05 ib_logfile1</div><div class="line">drwx------ 2 mysql mysql     4096 Apr 27 08:05 mysql</div><div class="line">-rw-rw---- 1 mysql mysql      245 Apr 27 08:05 mysql-bin.000001</div><div class="line">-rw-rw---- 1 mysql mysql       19 Apr 27 08:05 mysql-bin.index</div><div class="line">-rw-r----- 1 mysql mysql     1812 Apr 27 08:05 node1.anyisalin.com.err</div><div class="line">-rw-rw---- 1 mysql mysql        5 Apr 27 08:05 node1.anyisalin.com.pid</div><div class="line">drwx------ 2 mysql mysql     4096 Apr 27 08:05 performance_schema</div><div class="line">drwx------ 2 mysql mysql     4096 Apr 27 08:05 test</div><div class="line">drwx------ 2 mysql mysql     4096 Apr 27 08:05 TEST1</div><div class="line">drwx------ 2 mysql mysql     4096 Apr 27 08:05 TEST2</div><div class="line">-rw-r----- 1 mysql mysql       29 Apr 27 08:05 xtrabackup_binlog_pos_innodb</div><div class="line">-rw-r----- 1 mysql mysql      530 Apr 27 08:05 xtrabackup_info</div><div class="line"></div><div class="line">MariaDB [(none)]&gt; SHOW DATABASES;  #数据还原</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| TEST1              |</div><div class="line">| TEST2              |</div><div class="line">| employees          |</div><div class="line">| mysql              |</div><div class="line">| performance_schema |</div><div class="line">| test               |</div><div class="line">+--------------------+</div><div class="line">7 rows in set (0.00 sec)</div><div class="line"></div><div class="line">#关于xtrabackup还有很多强大的功能没有叙述、有兴趣可以去看官方文档</div></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><table>
<thead>
<tr>
<th>备份方法</th>
<th>备份速度</th>
<th style="text-align:center">恢复速度</th>
<th>便捷性</th>
<th style="text-align:center">功能</th>
<th>一般用于</th>
</tr>
</thead>
<tbody>
<tr>
<td>cp</td>
<td>快</td>
<td style="text-align:center">快</td>
<td>一般、灵活性低</td>
<td style="text-align:center">很弱</td>
<td>少量数据备份</td>
</tr>
<tr>
<td>mysqldump</td>
<td>慢</td>
<td style="text-align:center">慢</td>
<td>一般、可无视存储引擎的差异</td>
<td style="text-align:center">一般</td>
<td>中小型数据量的备份</td>
</tr>
<tr>
<td>lvm2快照</td>
<td>快</td>
<td style="text-align:center">快</td>
<td>一般、支持几乎热备、速度快</td>
<td style="text-align:center">一般</td>
<td>中小型数据量的备份</td>
</tr>
<tr>
<td>xtrabackup</td>
<td>较快</td>
<td style="text-align:center">较快</td>
<td>实现innodb热备、对存储引擎有要求</td>
<td style="text-align:center">强大</td>
<td>较大规模的备份</td>
</tr>
</tbody>
</table>

                </div>
                
                    <div class="article-tags tags">
                        
                            <a href="/tags/mysql/">
                                mysql
                            </a>
                            
                    </div>
                    
            </section>
            
                <section id="comments">
                    <div id="disqus_thread"></div>
                </section>
                
                    <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
                    <script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script>
                    <script>
                        var cloudTieConfig = {
                            url: document.location.href,
                            sourceId: "",
                            productKey: "4afa7e2e647a4ce796e196dccd91b207",
                            target: "cloud-tie-wrapper"
                        };
                        var yunManualLoad = true;
                        Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vcGMvbGl2ZXNjcmlwdC5odG1s", true);
                    </script>
</article>

<script>
    window.subData = {
        title: '学会用各种姿势备份MySQL数据库',
        tools: true
    }
</script>

      </div>
      <aside class='l_side'>
        
  <section class='m_widget about'>
    
        <img class='avatar waves-image' src='/images/avatar.jpg' />
        
            <div class='header'>
                Jason
            </div>
            <div class='content'>
                <div class='desc'>Tempora mutantur, nos et mutamur in illis ...</div>
            </div>
</section>


  <section class='m_widget links'>
<div class='header'>Links</div>
<div class='content'>
    <ul class="entry">
    
        <li><a class="flat-box" target="_blank" href="http://blog.tcina.com">
            <div class='name'>星辰</div>
        </a></li>
    
        <li><a class="flat-box" target="_blank" href="http://blog.csdn.net/cy8766/">
            <div class='name'>cjade的博客</div>
        </a></li>
    
    </ul>
</div>
</section>

  <section class='m_widget categories'>
<div class='header'>Categories</div>
<div class='content'>
    
    <ul class="entry">
    
        <li><a class="flat-box" href="/categories/Linux/"><div class='name'>Linux</div><div class='badget'>1</div></a></li>
    
        <li><a class="flat-box" href="/categories/MySql/"><div class='name'>MySql</div><div class='badget'>1</div></a></li>
    
        <li><a class="flat-box" href="/categories/php/laravel/"><div class='name'>laravel</div><div class='badget'>1</div></a></li>
    
        <li><a class="flat-box" href="/categories/php/"><div class='name'>php</div><div class='badget'>1</div></a></li>
    
    </ul>
    
</div>
</section>

  
<div class="m_widget tagcloud">
    <div class="header">Tags</div>
    <div class='content'>
        <a href="/tags/centos/" style="font-size: 14px; color: #808080">centos</a> <a href="/tags/geetest/" style="font-size: 14px; color: #808080">geetest</a> <a href="/tags/hexo/" style="font-size: 14px; color: #808080">hexo</a> <a href="/tags/laravel/" style="font-size: 14px; color: #808080">laravel</a> <a href="/tags/mysql/" style="font-size: 14px; color: #808080">mysql</a>
    </div>
</div>



      </aside>
      <script>setLoadingBarProgress(60);</script>
    </div>
  </div>
  <footer id="footer" class="clearfix">

	<div class="social-wrapper">
		
			
				<a href="https://github.com/cjade" class="social github" target="_blank" rel="external">
          <span class="icon icon-github"></span>
        </a>
				
				<a href="http://weibo.com/1751478944" class="social weibo" target="_blank" rel="external">
          <span class="icon icon-weibo"></span>
        </a>
				
				<a href="/atom.xml" class="social rss" target="_blank" rel="external">
          <span class="icon icon-rss"></span>
        </a>
				
					
	</div>

	<div>Theme <a href='https://github.com/cjade/cjade.github.io' class="codename">cjade.github.io</a> designed by <a href="http://mcoo.me/" target="_blank">MCOO</a>.</div>
	<script>
		var _hmt = _hmt || [];
		(function() {
			var hm = document.createElement("script");
			hm.src = "https://hm.baidu.com/hm.js?ba7756319d010eb50562b1b93c1869b4";
			var s = document.getElementsByTagName("script")[0];
			s.parentNode.insertBefore(hm, s);
		})();
	</script>
	<script>
		(function() {
			var bp = document.createElement('script');
			var curProtocol = window.location.protocol.split(':')[0];
			if (curProtocol === 'https') {
				bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
			} else {
				bp.src = 'http://push.zhanzhang.baidu.com/push.js';
			}
			var s = document.getElementsByTagName("script")[0];
			s.parentNode.insertBefore(bp, s);
		})();
	</script>


</footer>

  <script>setLoadingBarProgress(80);</script>
  
<script>
  var disqus_shortname = 'kevinhome';
  
  var disqus_url = 'http://www.mcoo.me/2017/06/06/学会用各种姿势备份MySQL数据库/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src='//cdn.bootcss.com/node-waves/0.7.5/waves.min.js'></script>
<script src="//cdn.bootcss.com/scrollReveal.js/3.3.2/scrollreveal.min.js"></script>
<script src="/js/jquery.fitvids.js"></script>
<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var BAIDU_API_ID = "";
  var SEARCH_SERVICE = "hexo";
  var ROOT = "/"||"/";
  if(!ROOT.endsWith('/'))ROOT += '/';
</script>
<script src="/js/search.js"></script>
<script src="/js/app.js"></script>


  <script>setLoadingBarProgress(100);</script>
</body>
</html>
