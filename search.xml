<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title><![CDATA[学会用各种姿势备份MySQL数据库]]></title>
      <url>/2017/06/06/%E5%AD%A6%E4%BC%9A%E7%94%A8%E5%90%84%E7%A7%8D%E5%A7%BF%E5%8A%BF%E5%A4%87%E4%BB%BDMySQL%E6%95%B0%E6%8D%AE%E5%BA%93/</url>
      <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p>我们试着想一想, 在生产环境中什么最重要？如果我们服务器的硬件坏了可以维修或者换新, 软件问题可以修复或重新安装, 但是如果数据没了呢？这可能是最恐怖的事情了吧, 我感觉在生产环境中应该没有什么比数据跟更为重要. 那么我们该如何保证数据不丢失、或者丢失后可以快速恢复呢？只要看完这篇, 大家应该就能对<code>MySQL</code>中实现数据备份和恢复能有一定的了解。</p>
</blockquote>
<a id="more"></a>
<h2 id="为什么需要备份数据？"><a href="#为什么需要备份数据？" class="headerlink" title="为什么需要备份数据？"></a>为什么需要备份数据？</h2><blockquote>
<p>其实在<code>前言</code>中也大概说明了为什么要备份数据, 但是我们还是应该具体了解一下为什么要备份数据</p>
<p>在生产环境中我们数据库可能会遭遇各种各样的不测从而导致数据丢失, 大概分为以下几种.</p>
<ul>
<li>硬件故障</li>
<li>软件故障</li>
<li>自然灾害</li>
<li>黑客攻击</li>
<li>误操作 (占比最大)</li>
</ul>
<p>所以, 为了在数据丢失之后能够恢复数据, 我们就需要定期的备份数据, 备份数据的策略要根据不同的应用场景进行定制, 大致有几个参考数值, 我们可以根据这些数值从而定制符合特定环境中的数据备份策略</p>
<ul>
<li>能够容忍丢失多少数据</li>
<li>恢复数据需要多长时间</li>
<li>需要恢复哪一些数据</li>
</ul>
</blockquote>
<h2 id="数据的备份类型"><a href="#数据的备份类型" class="headerlink" title="数据的备份类型"></a>数据的备份类型</h2><blockquote>
<p>数据的备份类型根据其自身的特性主要分为以下几组</p>
<ul>
<li><p>完全备份</p>
</li>
<li><p>部分备份</p>
<p>完全备份指的是<strong>备份整个数据集( 即整个数据库 )</strong>、部分备份指的是<strong>备份部分数据集(例如: 只备份一个表)</strong></p>
</li>
</ul>
<p>而部分备份又分为以下两种</p>
<ul>
<li><p>增量备份</p>
</li>
<li><p>差异备份</p>
<p>增量备份指的是<strong>备份自上一次备份以来(增量或完全)以来变化的数据</strong>; 特点: 节约空间、还原麻烦<br>差异备份指的是<strong>备份自上一次完全备份以来变化的数据</strong> 特点: 浪费空间、还原比增量备份简单</p>
</li>
</ul>
<p>示意图</p>
</blockquote>
<h2 id="MySQL备份数据的方式"><a href="#MySQL备份数据的方式" class="headerlink" title="MySQL备份数据的方式"></a><strong>MySQL备份数据的方式</strong></h2><blockquote>
<p>在<code>MySQl</code>中我们备份数据一般有几种方式</p>
<ul>
<li><p>热备份</p>
</li>
<li><p>温备份</p>
</li>
<li><p>冷备份</p>
<p>热备份指的是当数据库进行备份时, <strong>数据库的读写操作均不是受影响 </strong><br>温备份指的是当数据库进行备份时, <strong>数据库的读操作可以执行, 但是不能执行写操作</strong><br>冷备份指的是当数据库进行备份时, <strong>数据库不能进行读写操作, 即数据库要下线</strong></p>
</li>
</ul>
<p><code>MySQL</code>中进行不同方式的备份还要考虑存储引擎是否支持</p>
<ul>
<li><p>MyISAM </p>
<p> 热备 ×</p>
<p> 温备 √</p>
<p> 冷备 √</p>
</li>
<li><p>InnoDB</p>
<p> 热备 √</p>
<p> 温备 √</p>
<p> 冷备 √</p>
<p>我们在考虑完数据在备份时, 数据库的运行状态之后还需要考虑对于<code>MySQL</code>数据库中数据的备份方式</p>
<p>物理备份一般就是<strong>通过**</strong>tar,cp等命令直接打包复制数据库的数据文件<strong>达到备份的效果<br>逻辑备份一般就是</strong>通过特定工具从数据库中导出数据并另存备份**(逻辑备份会丢失数据精度)</p>
</li>
<li><ul>
<li>物理备份</li>
<li>逻辑备份</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="备份需要考虑的问题"><a href="#备份需要考虑的问题" class="headerlink" title="备份需要考虑的问题"></a>备份需要考虑的问题</h2><blockquote>
<p>定制备份策略前, 我们还需要考虑一些问题</p>
<p><strong>我们要备份什么?</strong></p>
<p>一般情况下, 我们需要备份的数据分为以下几种</p>
<ul>
<li>数据</li>
<li>二进制日志, InnoDB事务日志</li>
<li>代码(存储过程、存储函数、触发器、事件调度器)</li>
<li>服务器配置文件</li>
</ul>
<p><strong>备份工具</strong></p>
<p>这里我们列举出常用的几种备份工具<br><code>mysqldump</code> : 逻辑备份工具, 适用于所有的存储引擎, 支持温备、完全备份、部分备份、对于<strong>InnoDB</strong>存储引擎支持热备<br><code>cp, tar 等归档复制工具</code>: 物理备份工具, 适用于所有的存储引擎, 冷备、完全备份、部分备份<br><code>lvm2 snapshot</code>: 几乎热备, 借助文件系统管理工具进行备份<br><code>mysqlhotcopy</code>: 名不副实的的一个工具, 几乎冷备, 仅支持<strong>MyISAM</strong>存储引擎<br><code>xtrabackup</code>: 一款非常强大的<strong>InnoDB/XtraDB</strong>热备工具, 支持完全备份、增量备份, 由<code>percona</code>提供</p>
</blockquote>
<h2 id="设计合适的备份策略"><a href="#设计合适的备份策略" class="headerlink" title="设计合适的备份策略"></a>设计合适的备份策略</h2><blockquote>
<p>针对不同的场景下, 我们应该制定不同的备份策略对数据库进行备份, 一般情况下, 备份策略一般为以下三种</p>
<ul>
<li><strong>直接cp,tar复制数据库文件</strong></li>
<li><strong>mysqldump+复制BIN LOGS</strong></li>
<li><strong>lvm2快照+复制BIN LOGS</strong></li>
<li><strong>xtrabackup</strong></li>
</ul>
<p>以上的几种解决方案分别针对于不同的场景</p>
<ol>
<li>如果数据量较小, 可以使用第一种方式, 直接复制数据库文件</li>
<li>如果数据量还行, 可以使用第二种方式, 先使用mysqldump对数据库进行完全备份, 然后定期备份BINARY LOG达到增量备份的效果</li>
<li>如果数据量一般, 而又不过分影响业务运行, 可以使用第三种方式, 使用<code>lvm2</code>的快照对数据文件进行备份, 而后定期备份BINARY LOG达到增量备份的效果</li>
<li>如果数据量很大, 而又不过分影响业务运行, 可以使用第四种方式, 使用<code>xtrabackup</code>进行完全备份后, 定期使用<code>xtrabackup</code>进行增量备份或差异备份</li>
</ol>
</blockquote>
<h2 id="实战演练"><a href="#实战演练" class="headerlink" title="实战演练"></a>实战演练</h2><h3 id="使用cp进行备份"><a href="#使用cp进行备份" class="headerlink" title="使用cp进行备份"></a>使用cp进行备份</h3><blockquote>
<p>我们这里使用的是使用yum安装的<code>mysql-5.1</code>的版本, 使用的数据集为从网络上找到的一个员工数据库</p>
</blockquote>
<p><strong>查看数据库的信息</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SHOW DATABASES;    #查看当前的数据库, 我们的数据库为employees</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| employees          |</div><div class="line">| mysql              |</div><div class="line">| test               |</div><div class="line">+--------------------+</div><div class="line">4 rows in set (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; USE employees;</div><div class="line">Database changed</div><div class="line">mysql&gt; SHOW TABLES;         #查看当前库中的表</div><div class="line">+---------------------+</div><div class="line">| Tables_in_employees |</div><div class="line">+---------------------+</div><div class="line">| departments         |</div><div class="line">| dept_emp            |</div><div class="line">| dept_manager        |</div><div class="line">| employees           |</div><div class="line">| salaries            |</div><div class="line">| titles              |</div><div class="line">+---------------------+</div><div class="line">6 rows in set (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; SELECT COUNT(*) FROM employees;   #由于篇幅原因, 我们这里只看一下employees的行数为300024</div><div class="line">+----------+</div><div class="line">| COUNT(*) |</div><div class="line">+----------+</div><div class="line">|   300024 |</div><div class="line">+----------+</div><div class="line">1 row in set (0.05 sec)</div></pre></td></tr></table></figure>
<p><strong>向数据库施加读锁</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; FLUSH TABLES WITH READ LOCK;    #向所有表施加读锁</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div></pre></td></tr></table></figure>
<p><strong>备份数据文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]# mkdir /backup   #创建文件夹存放备份数据库文件</div><div class="line">[root@node1 ~]# cp -a /var/lib/mysql/* /backup     #保留权限的拷贝源数据文件</div><div class="line">[root@node1 ~]# ls /backup   #查看目录下的文件</div><div class="line">employees  ibdata1  ib_logfile0  ib_logfile1  mysql  mysql.sock  test</div></pre></td></tr></table></figure>
<p><strong>模拟数据丢失并恢复</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]# rm -rf /var/lib/mysql/*    #删除数据库的所有文件</div><div class="line">[root@node1 ~]# service mysqld restart   #重启MySQL, 如果是编译安装的应该不能启动, 如果rpm安装则会重新初始化数据库</div><div class="line"></div><div class="line"></div><div class="line">mysql&gt; SHOW DATABASES;    #因为我们是rpm安装的, 连接到MySQL进行查看, 发现数据丢失了！</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| mysql              |</div><div class="line">| test               |</div><div class="line">+--------------------+</div><div class="line">3 rows in set (0.00 sec)</div><div class="line"></div><div class="line">[root@node1 ~]# rm -rf /var/lib/mysql/*    #这一步可以不做</div><div class="line">[root@node1 ~]# cp -a /backup/* /var/lib/mysql/    #将备份的数据文件拷贝回去</div><div class="line">[root@node1 ~]# service mysqld restart  #重启MySQL</div><div class="line"></div><div class="line"></div><div class="line">#重新连接数据并查看</div><div class="line"></div><div class="line">mysql&gt; SHOW DATABASES;    #数据库已恢复</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| employees          |</div><div class="line">| mysql              |</div><div class="line">| test               |</div><div class="line">+--------------------+</div><div class="line">4 rows in set (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; USE employees;      </div><div class="line"></div><div class="line">mysql&gt; SELECT COUNT(*) FROM employees;    #表的行数没有变化</div><div class="line">+----------+</div><div class="line">| COUNT(*) |</div><div class="line">+----------+</div><div class="line">|   300024 |</div><div class="line">+----------+</div><div class="line">1 row in set (0.06 sec)</div><div class="line"></div><div class="line"></div><div class="line">##完成</div></pre></td></tr></table></figure>
<h3 id="使用mysqldump-复制BINARY-LOG备份"><a href="#使用mysqldump-复制BINARY-LOG备份" class="headerlink" title="使用mysqldump+复制BINARY LOG备份"></a>使用mysqldump+复制BINARY LOG备份</h3><blockquote>
<p>我们这里使用的是使用yum安装的<code>mysql-5.1</code>的版本, 使用的数据集为从网络上找到的一个员工数据库</p>
<p>我们通过mysqldump进行一次完全备份, 再修改表中的数据, 然后再通过binary log进行恢复 <strong>二进制日志需要在mysql配置文件中添加 log_bin=on 开启</strong></p>
</blockquote>
<p><strong>mysqldump命令介绍</strong></p>
<blockquote>
<p><code>mysqldump</code>是一个客户端的逻辑备份工具, 可以生成一个重现创建原始数据库和表的SQL语句, 可以支持所有的存储引擎, 对于InnoDB支持热备</p>
<p><a href="http://dev.mysql.com/doc/refman/5.7/en/mysqldump.html" target="_blank" rel="external">官方文档介绍</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">#基本语法格式</div><div class="line"></div><div class="line">shell&gt; mysqldump [options] db_name [tbl_name ...]    恢复需要手动CRATE DATABASES</div><div class="line">shell&gt; mysqldump [options] --databases db_name ...   恢复不需要手动创建数据库</div><div class="line">shell&gt; mysqldump [options] --all-databases           恢复不需要手动创建数据库</div><div class="line"></div><div class="line"></div><div class="line">其他选项:</div><div class="line">     -E, --events: 备份事件调度器</div><div class="line">     -R, --routines: 备份存储过程和存储函数</div><div class="line">     --triggers: 备份表的触发器; --skip-triggers </div><div class="line">     --master-date[=value]  </div><div class="line">         1: 记录为CHANGE MASTER TO 语句、语句不被注释</div><div class="line">         2: 记录为注释的CHANGE MASTER TO语句</div><div class="line">         基于二进制还原只能全库还原</div><div class="line"></div><div class="line">     --flush-logs: 日志滚动</div><div class="line">         锁定表完成后执行日志滚动</div></pre></td></tr></table></figure>
<p><strong>查看数据库的信息</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SHOW DATABASES;    #查看当前的数据库, 我们的数据库为employees</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| employees          |</div><div class="line">| mysql              |</div><div class="line">| test               |</div><div class="line">+--------------------+</div><div class="line">4 rows in set (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; USE employees;</div><div class="line">Database changed</div><div class="line">mysql&gt; SHOW TABLES;         #查看当前库中的表</div><div class="line">+---------------------+</div><div class="line">| Tables_in_employees |</div><div class="line">+---------------------+</div><div class="line">| departments         |</div><div class="line">| dept_emp            |</div><div class="line">| dept_manager        |</div><div class="line">| employees           |</div><div class="line">| salaries            |</div><div class="line">| titles              |</div><div class="line">+---------------------+</div><div class="line">6 rows in set (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; SELECT COUNT(*) FROM employees;   #由于篇幅原因, 我们这里只看一下employees的行数为300024</div><div class="line">+----------+</div><div class="line">| COUNT(*) |</div><div class="line">+----------+</div><div class="line">|   300024 |</div><div class="line">+----------+</div><div class="line">1 row in set (0.05 sec)</div></pre></td></tr></table></figure>
<p><strong>使用mysqldump备份数据库</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]# mysql -e &apos;SHOW MASTER STATUS&apos;   #查看当前二进制文件的状态, 并记录下position的数字</div><div class="line">+------------------+----------+--------------+------------------+</div><div class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |</div><div class="line">+------------------+----------+--------------+------------------+</div><div class="line">| mysql-bin.000003 |      106 |              |                  |</div><div class="line">+------------------+----------+--------------+------------------+</div><div class="line"></div><div class="line">[root@node1 ~]# mysqldump --all-databases --lock-all-tables  &gt; backup.sql   #备份数据库到backup.sql文件中</div><div class="line"></div><div class="line">mysql&gt; CREATE DATABASE TEST1;   #创建一个数据库</div><div class="line">Query OK, 1 row affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; SHOW MASTER STATUS;   #记下现在的position</div><div class="line">+------------------+----------+--------------+------------------+</div><div class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |</div><div class="line">+------------------+----------+--------------+------------------+</div><div class="line">| mysql-bin.000003 |      191 |              |                  |</div><div class="line">+------------------+----------+--------------+------------------+</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line">[root@node1 ~]# cp /var/lib/mysql/mysql-bin.000003 /root  #备份二进制文件</div><div class="line">[root@node1 ~]# service mysqld stop   #停止MySQL</div><div class="line">[root@node1 ~]# rm -rf /var/lib/mysql/*   #删除所有的数据文件</div><div class="line">[root@node1 ~]# service mysqld start    #启动MySQL, 如果是编译安装的应该不能启动(需重新初始化), 如果rpm安装则会重新初始化数据库</div><div class="line"></div><div class="line"></div><div class="line">mysql&gt; SHOW DATABASES;   #查看数据库, 数据丢失!</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| mysql              |</div><div class="line">| test               |</div><div class="line">+--------------------+</div><div class="line">3 rows in set (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; SET sql_log_bin=OFF;   #暂时先将二进制日志关闭  </div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line"></div><div class="line">mysql&gt; source backup.sql  #恢复数据，所需时间根据数据库时间大小而定</div><div class="line"></div><div class="line">mysql&gt; SET sql_log_bin=ON; 开启二进制日志</div><div class="line"></div><div class="line">mysql&gt; SHOW DATABASES;   #数据库恢复, 但是缺少TEST1</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| employees          |</div><div class="line">| mysql              |</div><div class="line">| test               |</div><div class="line">+--------------------+</div><div class="line">4 rows in set (0.00 sec)</div><div class="line"></div><div class="line">[root@node1 ~]# mysqlbinlog --start-position=106 --stop-position=191 mysql-bin.000003 | mysql employees #通过二进制日志增量恢复数据</div><div class="line"></div><div class="line">mysql&gt; SHOW DATABASES;    #现在TEST1出现了！</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| TEST1              |</div><div class="line">| employees          |</div><div class="line">| mysql              |</div><div class="line">| test               |</div><div class="line">+--------------------+</div><div class="line">5 rows in set (0.00 sec)</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">#完成</div></pre></td></tr></table></figure>
<h3 id="使用lvm2快照备份数据"><a href="#使用lvm2快照备份数据" class="headerlink" title="使用lvm2快照备份数据"></a>使用lvm2快照备份数据</h3><blockquote>
<p>做实验之前我们先回顾一下<code>lvm2-snapshot</code>的知识</p>
<p><code>LVM</code>快照简单来说就是将所快照源分区一个时间点所有文件的元数据进行保存，如果源文件没有改变，那么访问快照卷的相应文件则直接指向源分区的源文件，如果源文件发生改变，则快照卷中与之对应的文件不会发生改变。快照卷主要用于辅助备份文件。 这里只简单介绍，<a href="http://www.360doc.com/content/13/0522/16/11801283_287305129.shtml" target="_blank" rel="external">点击查看详细介绍</a></p>
</blockquote>
<p><strong>部署lvm环境</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line">添加硬盘; 这里我们直接实现SCSI硬盘的热插拔, 首先在虚拟机中添加一块硬盘, 不重启</div><div class="line"></div><div class="line">[root@node1 ~]# ls /dev/sd*   #只有以下几块硬盘, 但是我们不重启可以让系统识别新添加的硬盘</div><div class="line">/dev/sda  /dev/sda1  /dev/sda2</div><div class="line"></div><div class="line">[root@node1 ~]# echo &apos;- - -&apos; &gt; /sys/class/scsi_host/host0/scan </div><div class="line">[root@node1 ~]# echo &apos;- - -&apos; &gt; /sys/class/scsi_host/host1/scan </div><div class="line">[root@node1 ~]# echo &apos;- - -&apos; &gt; /sys/class/scsi_host/host2/scan </div><div class="line"></div><div class="line">[root@node1 ~]# ls /dev/sd*    #看！sdb识别出来了</div><div class="line">/dev/sda  /dev/sda1  /dev/sda2  /dev/sdb</div><div class="line"></div><div class="line"></div><div class="line">[root@node1 ~]# fdisk /dev/sdb   #分区</div><div class="line">Device contains neither a valid DOS partition table, nor Sun, SGI or OSF disklabel</div><div class="line">Building a new DOS disklabel with disk identifier 0xd353d192.</div><div class="line">Changes will remain in memory only, until you decide to write them.</div><div class="line">After that, of course, the previous content won&apos;t be recoverable.</div><div class="line"></div><div class="line">Warning: invalid flag 0x0000 of partition table 4 will be corrected by w(rite)</div><div class="line"></div><div class="line">WARNING: DOS-compatible mode is deprecated. It&apos;s strongly recommended to</div><div class="line">         switch off the mode (command &apos;c&apos;) and change display units to</div><div class="line">         sectors (command &apos;u&apos;).</div><div class="line"></div><div class="line">Command (m for help): n</div><div class="line">Command action</div><div class="line">   e   extended</div><div class="line">   p   primary partition (1-4)</div><div class="line">p</div><div class="line">Partition number (1-4): 1</div><div class="line">First cylinder (1-2610, default 1): </div><div class="line">Using default value 1</div><div class="line">Last cylinder, +cylinders or +size&#123;K,M,G&#125; (1-2610, default 2610): +15G</div><div class="line"></div><div class="line">Command (m for help): t</div><div class="line">Selected partition 1</div><div class="line">Hex code (type L to list codes): 8e</div><div class="line">Changed system type of partition 1 to 8e (Linux LVM)</div><div class="line"></div><div class="line">Command (m for help): w</div><div class="line">The partition table has been altered!</div><div class="line"></div><div class="line">Calling ioctl() to re-read partition table.</div><div class="line">Syncing disks.</div><div class="line">You have new mail in /var/spool/mail/root</div><div class="line">[root@node1 ~]# partx -a /dev/sdb</div><div class="line">BLKPG: Device or resource busy</div><div class="line">error adding partition 1</div><div class="line"></div><div class="line">##创建逻辑卷</div><div class="line">[root@node1 ~]# pvcreate /dev/sdb1</div><div class="line">  Physical volume &quot;/dev/sdb1&quot; successfully created</div><div class="line">[root@node1 ~]# vgcreate myvg /dev/sdb1 </div><div class="line">  Volume group &quot;myvg&quot; successfully created</div><div class="line">[root@node1 ~]# lvcreate -n mydata -L 5G myvg </div><div class="line">  Logical volume &quot;mydata&quot; created.</div><div class="line"></div><div class="line">[root@node1 ~]# mkfs.ext4 /dev/mapper/myvg-mydata   #格式化</div><div class="line">[root@node1 ~]# mkdir /lvm_data</div><div class="line">[root@node1 ~]# mount /dev/mapper/myvg-mydata /lvm_data  #挂载到/lvm_data</div><div class="line"></div><div class="line"></div><div class="line">[root@node1 ~]# vim /etc/my.cnf    #修改mysql配置文件的datadir如下</div><div class="line"></div><div class="line">datadir=/lvm_data</div><div class="line"></div><div class="line">[root@node1 ~]# service mysqld restart  #重启MySQL</div><div class="line"></div><div class="line">####重新导入employees数据库########略过####</div></pre></td></tr></table></figure>
<p><strong>查看数据库的信息</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SHOW DATABASES;    #查看当前的数据库, 我们的数据库为employees</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| employees          |</div><div class="line">| mysql              |</div><div class="line">| test               |</div><div class="line">+--------------------+</div><div class="line">4 rows in set (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; USE employees;</div><div class="line">Database changed</div><div class="line">mysql&gt; SHOW TABLES;         #查看当前库中的表</div><div class="line">+---------------------+</div><div class="line">| Tables_in_employees |</div><div class="line">+---------------------+</div><div class="line">| departments         |</div><div class="line">| dept_emp            |</div><div class="line">| dept_manager        |</div><div class="line">| employees           |</div><div class="line">| salaries            |</div><div class="line">| titles              |</div><div class="line">+---------------------+</div><div class="line">6 rows in set (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; SELECT COUNT(*) FROM employees;   #由于篇幅原因, 我们这里只看一下employees的行数为300024</div><div class="line">+----------+</div><div class="line">| COUNT(*) |</div><div class="line">+----------+</div><div class="line">|   300024 |</div><div class="line">+----------+</div><div class="line">1 row in set (0.05 sec)</div></pre></td></tr></table></figure>
<p><strong>创建快照卷并备份</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">mysql&gt; FLUSH TABLES WITH READ LOCK;     #锁定所有表</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">[root@node1 lvm_data]# lvcreate -L 1G -n mydata-snap -p r -s /dev/mapper/myvg-mydata   #创建快照卷</div><div class="line">  Logical volume &quot;mydata-snap&quot; created.</div><div class="line"></div><div class="line">mysql&gt; UNLOCK TABLES;  #解锁所有表</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">[root@node1 lvm_data]# mkdir /lvm_snap  #创建文件夹</div><div class="line">[root@node1 lvm_data]# mount /dev/myvg/mydata-snap /lvm_snap/  #挂载snap</div><div class="line">mount: block device /dev/mapper/myvg-mydata--snap is write-protected, mounting read-only</div><div class="line"></div><div class="line">[root@node1 lvm_data]# cd /lvm_snap/</div><div class="line">[root@node1 lvm_snap]# ls</div><div class="line">employees  ibdata1  ib_logfile0  ib_logfile1  mysql  mysql-bin.000001  mysql-bin.000002  mysql-bin.000003  mysql-bin.index  test</div><div class="line">[root@node1 lvm_snap]# tar cf /tmp/mysqlback.tar *  #打包文件到/tmp/mysqlback.tar</div><div class="line"></div><div class="line">[root@node1 ~]# umount /lvm_snap/  #卸载snap</div><div class="line">[root@node1 ~]# lvremove myvg mydata-snap  #删除snap</div></pre></td></tr></table></figure>
<p><strong>恢复数据</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">[root@node1 lvm_snap]# rm -rf /lvm_data/*</div><div class="line">[root@node1 ~]# service mysqld start    #启动MySQL, 如果是编译安装的应该不能启动(需重新初始化), 如果rpm安装则会重新初始化数据库</div><div class="line"></div><div class="line"></div><div class="line">mysql&gt; SHOW DATABASES;   #查看数据库, 数据丢失!</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| mysql              |</div><div class="line">| test               |</div><div class="line">+--------------------+</div><div class="line">3 rows in set (0.00 sec)</div><div class="line"></div><div class="line">[root@node1 ~]# cd /lvm_data/</div><div class="line">[root@node1 lvm_data]# rm -rf * #删除所有文件</div><div class="line">[root@node1 lvm_data]# tar xf /tmp/mysqlback.tar     #解压备份数据库到此文件夹 </div><div class="line">[root@node1 lvm_data]# ls  #查看当前的文件</div><div class="line">employees  ibdata1  ib_logfile0  ib_logfile1  mysql  mysql-bin.000001  mysql-bin.000002  mysql-bin.000003  mysql-bin.index  test</div><div class="line"></div><div class="line">mysql&gt; SHOW DATABASES;  #数据恢复了</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| employees          |</div><div class="line">| mysql              |</div><div class="line">| test               |</div><div class="line">+--------------------+</div><div class="line">4 rows in set (0.00 sec)</div><div class="line"></div><div class="line"></div><div class="line">##完成</div></pre></td></tr></table></figure>
<h3 id="使用Xtrabackup备份"><a href="#使用Xtrabackup备份" class="headerlink" title="使用Xtrabackup备份"></a>使用Xtrabackup备份</h3><blockquote>
<p>为了更好地演示, 我们这次使用<code>mariadb-5.5</code>的版本, 使用<code>xtrabackup</code>使用InnoDB能够发挥其最大功效, 并且InnoDB的每一张表必须使用单独的表空间, 我们需要在配置文件中添加 <code>innodb_file_per_table = ON</code> 来开启</p>
</blockquote>
<p><strong>下载安装xtrabackup</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">我们这里通过wget percona官方的rpm包进行安装</div><div class="line">[root@node1 ~]# wget https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.3.4/binary/redhat/6/x86_64/percona-xtrabackup-2.3.4-1.el6.x86_64.rpm   </div><div class="line">[root@node1 ~]# yum localinstall percona-xtrabackup-2.3.4-1.el6.x86_64.rpm   #需要EPEL源</div></pre></td></tr></table></figure>
<p><strong>xtrabackup介绍</strong></p>
<blockquote>
<p><code>Xtrabackup</code>是由<code>percona</code>提供的<code>mysql</code>数据库备份工具，据官方介绍，这也是世界上惟一一款开源的能够对innodb和xtradb数据库进行热备的工具。特点：</p>
<ol>
<li>备份过程快速、可靠；</li>
<li>备份过程不会打断正在执行的事务；</li>
<li>能够基于压缩等功能节约磁盘空间和流量；</li>
<li>自动实现备份检验；</li>
<li>还原速度快；</li>
</ol>
<p><strong>摘自马哥的文档</strong></p>
</blockquote>
<p><strong>xtrabackup实现完全备份</strong></p>
<blockquote>
<p>我们这里使用<code>xtrabackup</code>的前端配置工具<code>innobackupex</code>来实现对数据库的完全备份</p>
<p>使用<code>innobackupex</code>备份时, 会调用<code>xtrabackup</code>备份所有的<strong>InnoDB</strong>表, 复制所有关于表结构定义的相关文件(.frm)、以及<strong>MyISAM</strong>、<strong>MERGE</strong>、<strong>CSV</strong>和<strong>ARCHIVE</strong>表的相关文件, 同时还会备份触发器和数据库配置文件信息相关的文件, 这些文件会被保存至一个以时间命名的目录.</p>
</blockquote>
<p><strong>备份过程</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]# mkdir /extrabackup  #创建备份目录</div><div class="line">[root@node1 ~]# innobackupex --user=root /extrabackup/ #备份数据</div><div class="line">###################提示complete表示成功*********************</div><div class="line"></div><div class="line">[root@node1 ~]# ls /extrabackup/  #看到备份目录</div><div class="line">2016-04-27_07-30-48</div></pre></td></tr></table></figure>
<blockquote>
<p>一般情况, 备份完成后, 数据不能用于恢复操作, 因为备份的数据中可能会包含尚未提交的事务或已经提交但尚未同步至数据文件中的事务。因此, 此时的数据文件仍不一致, 所以我们需要”准备”一个完全备份</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]# innobackupex --apply-log /extrabackup/2016-04-27_07-30-48/  #指定备份文件的目录</div><div class="line"></div><div class="line">#一般情况下下面三行结尾代表成功*****************</div><div class="line">InnoDB: Starting shutdown...</div><div class="line">InnoDB: Shutdown completed; log sequence number 369661462</div><div class="line">160427 07:40:11 completed OK!</div><div class="line"></div><div class="line">[root@node1 ~]# cd /extrabackup/2016-04-27_07-30-48/</div><div class="line">[root@node1 2016-04-27_07-30-48]# ls -hl  #查看备份文件</div><div class="line">total 31M</div><div class="line">-rw-r----- 1 root root  386 Apr 27 07:30 backup-my.cnf</div><div class="line">drwx------ 2 root root 4.0K Apr 27 07:30 employees</div><div class="line">-rw-r----- 1 root root  18M Apr 27 07:40 ibdata1</div><div class="line">-rw-r--r-- 1 root root 5.0M Apr 27 07:40 ib_logfile0</div><div class="line">-rw-r--r-- 1 root root 5.0M Apr 27 07:40 ib_logfile1</div><div class="line">drwx------ 2 root root 4.0K Apr 27 07:30 mysql</div><div class="line">drwx------ 2 root root 4.0K Apr 27 07:30 performance_schema</div><div class="line">drwx------ 2 root root 4.0K Apr 27 07:30 test</div><div class="line">-rw-r----- 1 root root   27 Apr 27 07:30 xtrabackup_binlog_info</div><div class="line">-rw-r--r-- 1 root root   29 Apr 27 07:40 xtrabackup_binlog_pos_innodb</div><div class="line">-rw-r----- 1 root root  117 Apr 27 07:40 xtrabackup_checkpoints</div><div class="line">-rw-r----- 1 root root  470 Apr 27 07:30 xtrabackup_info</div><div class="line">-rw-r----- 1 root root 2.0M Apr 27 07:40 xtrabackup_logfile</div></pre></td></tr></table></figure>
<p><strong>恢复数据</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]# rm -rf /data/*   #删除数据文件</div><div class="line"></div><div class="line">***不用启动数据库也可以还原*************</div><div class="line"></div><div class="line">[root@node1 ~]# innobackupex --copy-back /extrabackup/2016-04-27_07-30-48/   #恢复数据, 记清使用方法</div><div class="line"></div><div class="line">#########我们这里是编译安装的mariadb所以需要做一些操作##########</div><div class="line">[root@node1 data]# killall mysqld</div><div class="line"></div><div class="line">[root@node1 ~]# chown -R mysql:mysql ./* </div><div class="line">[root@node1 ~]# ll /data/      #数据恢复</div><div class="line">total 28704</div><div class="line">-rw-rw---- 1 mysql mysql    16384 Apr 27 07:43 aria_log.00000001</div><div class="line">-rw-rw---- 1 mysql mysql       52 Apr 27 07:43 aria_log_control</div><div class="line">-rw-rw---- 1 mysql mysql 18874368 Apr 27 07:43 ibdata1</div><div class="line">-rw-rw---- 1 mysql mysql  5242880 Apr 27 07:43 ib_logfile0</div><div class="line">-rw-rw---- 1 mysql mysql  5242880 Apr 27 07:43 ib_logfile1</div><div class="line">-rw-rw---- 1 mysql mysql      264 Apr 27 07:43 mysql-bin.000001</div><div class="line">-rw-rw---- 1 mysql mysql       19 Apr 27 07:43 mysql-bin.index</div><div class="line">-rw-r----- 1 mysql mysql     2166 Apr 27 07:43 node1.anyisalin.com.err</div><div class="line"></div><div class="line"></div><div class="line">[root@node1 data]# service mysqld restart</div><div class="line">MySQL server PID file could not be found!                  [FAILED]</div><div class="line">Starting MySQL..                                           [  OK  ]</div><div class="line"></div><div class="line">MariaDB [(none)]&gt; SHOW DATABASES;  #查看数据库, 已经恢复</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| employees          |</div><div class="line">| mysql              |</div><div class="line">| performance_schema |</div><div class="line">| test               |</div><div class="line">+--------------------+</div><div class="line">5 rows in set (0.00 sec</div></pre></td></tr></table></figure>
<p><strong>增量备份</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">#########创建连两个数据库以供测试#####################</div><div class="line">MariaDB [(none)]&gt; CREATE DATABASE TEST1;</div><div class="line">Query OK, 1 row affected (0.00 sec)</div><div class="line"></div><div class="line">MariaDB [(none)]&gt; CREATE DATABASE TEST2;</div><div class="line">Query OK, 1 row affected (0.00 sec)</div><div class="line"></div><div class="line">[root@node1 ~]# innobackupex --incremental /extrabackup/ --incremental-basedir=/extrabackup/2016-04-27_07-30-48/ </div><div class="line"></div><div class="line">[root@node1 ~]# ls /extrabackup/2016-04-27_07-57-22/ #查看备份文件</div><div class="line">total 96</div><div class="line">-rw-r----- 1 root root   386 Apr 27 07:57 backup-my.cnf</div><div class="line">drwx------ 2 root root  4096 Apr 27 07:57 employees</div><div class="line">-rw-r----- 1 root root 49152 Apr 27 07:57 ibdata1.delta</div><div class="line">-rw-r----- 1 root root    44 Apr 27 07:57 ibdata1.meta</div><div class="line">drwx------ 2 root root  4096 Apr 27 07:57 mysql</div><div class="line">drwx------ 2 root root  4096 Apr 27 07:57 performance_schema</div><div class="line">drwx------ 2 root root  4096 Apr 27 07:57 test</div><div class="line">drwx------ 2 root root  4096 Apr 27 07:57 TEST1</div><div class="line">drwx------ 2 root root  4096 Apr 27 07:57 TEST2</div><div class="line">-rw-r----- 1 root root    21 Apr 27 07:57 xtrabackup_binlog_info</div><div class="line">-rw-r----- 1 root root   123 Apr 27 07:57 xtrabackup_checkpoints</div><div class="line">-rw-r----- 1 root root   530 Apr 27 07:57 xtrabackup_info</div><div class="line">-rw-r----- 1 root root  2560 Apr 27 07:57 xtrabackup_logfile</div></pre></td></tr></table></figure>
<blockquote>
<p>BASEDIR指的是完全备份所在的目录，此命令执行结束后，<code>innobackupex</code>命令会在<code>/extrabackup</code>目录中创建一个新的以时间命名的目录以存放所有的增量备份数据。另外，在执行过增量备份之后再一次进行增量备份时，其<code>--incremental-basedir</code>应该指向上一次的增量备份所在的目录。</p>
<p>需要注意的是，增量备份仅能应用于InnoDB或XtraDB表，对于MyISAM表而言，执行增量备份时其实进行的是完全备份。</p>
</blockquote>
<p><strong>整理增量备份</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]# innobackupex --apply-log --redo-only /extrabackup/2016-04-27_07-30-48/</div><div class="line">[root@node1 ~]# innobackupex --apply-log --redo-only /extrabackup/2016-04-27_07-30-48/ --incremental-dir=/extrabackup/2016-04-27_07-5</div><div class="line">7-22/</div></pre></td></tr></table></figure>
<p><strong>恢复数据</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">[root@node1 ~]# rm -rf /data/*   #删除数据</div><div class="line"></div><div class="line">[root@node1 ~]# innobackupex --copy-back /extrabackup/2016-04-27_07-30-48/     #整理增量备份之后可以直接通过全量备份还原</div><div class="line"></div><div class="line">[root@node1 ~]# chown -R mysql.mysql /data/</div><div class="line">[root@node1 ~]# ls /data/ -l</div><div class="line">total 28732</div><div class="line">-rw-rw---- 1 mysql mysql     8192 Apr 27 08:05 aria_log.00000001</div><div class="line">-rw-rw---- 1 mysql mysql       52 Apr 27 08:05 aria_log_control</div><div class="line">drwx------ 2 mysql mysql     4096 Apr 27 08:05 employees</div><div class="line">-rw-r----- 1 mysql mysql 18874368 Apr 27 08:05 ibdata1</div><div class="line">-rw-r----- 1 mysql mysql  5242880 Apr 27 08:05 ib_logfile0</div><div class="line">-rw-r----- 1 mysql mysql  5242880 Apr 27 08:05 ib_logfile1</div><div class="line">drwx------ 2 mysql mysql     4096 Apr 27 08:05 mysql</div><div class="line">-rw-rw---- 1 mysql mysql      245 Apr 27 08:05 mysql-bin.000001</div><div class="line">-rw-rw---- 1 mysql mysql       19 Apr 27 08:05 mysql-bin.index</div><div class="line">-rw-r----- 1 mysql mysql     1812 Apr 27 08:05 node1.anyisalin.com.err</div><div class="line">-rw-rw---- 1 mysql mysql        5 Apr 27 08:05 node1.anyisalin.com.pid</div><div class="line">drwx------ 2 mysql mysql     4096 Apr 27 08:05 performance_schema</div><div class="line">drwx------ 2 mysql mysql     4096 Apr 27 08:05 test</div><div class="line">drwx------ 2 mysql mysql     4096 Apr 27 08:05 TEST1</div><div class="line">drwx------ 2 mysql mysql     4096 Apr 27 08:05 TEST2</div><div class="line">-rw-r----- 1 mysql mysql       29 Apr 27 08:05 xtrabackup_binlog_pos_innodb</div><div class="line">-rw-r----- 1 mysql mysql      530 Apr 27 08:05 xtrabackup_info</div><div class="line"></div><div class="line">MariaDB [(none)]&gt; SHOW DATABASES;  #数据还原</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| TEST1              |</div><div class="line">| TEST2              |</div><div class="line">| employees          |</div><div class="line">| mysql              |</div><div class="line">| performance_schema |</div><div class="line">| test               |</div><div class="line">+--------------------+</div><div class="line">7 rows in set (0.00 sec)</div><div class="line"></div><div class="line">#关于xtrabackup还有很多强大的功能没有叙述、有兴趣可以去看官方文档</div></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><table>
<thead>
<tr>
<th>备份方法</th>
<th>备份速度</th>
<th>恢复速度</th>
<th>便捷性</th>
<th>功能</th>
<th>一般用于</th>
</tr>
</thead>
<tbody>
<tr>
<td>cp</td>
<td>快</td>
<td>快</td>
<td>一般、灵活性低</td>
<td>很弱</td>
<td>少量数据备份</td>
</tr>
<tr>
<td>mysqldump</td>
<td>慢</td>
<td>慢</td>
<td>一般、可无视存储引擎的差异</td>
<td>一般</td>
<td>中小型数据量的备份</td>
</tr>
<tr>
<td>lvm2快照</td>
<td>快</td>
<td>快</td>
<td>一般、支持几乎热备、速度快</td>
<td>一般</td>
<td>中小型数据量的备份</td>
</tr>
<tr>
<td>xtrabackup</td>
<td>较快</td>
<td>较快</td>
<td>实现innodb热备、对存储引擎有要求</td>
<td>强大</td>
<td>较大规模的备份</td>
</tr>
</tbody>
</table>
]]></content>
      
        <categories>
            
            <category> MySql </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Hello World]]></title>
      <url>/2017/06/05/hello-world/</url>
      <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo new <span class="string">"My New Post"</span></div></pre></td></tr></table></figure>
<a id="more"></a>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo server</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo generate</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo deploy</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>
]]></content>
      
        
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[laravel5.4整合极验验证码3.0]]></title>
      <url>/2017/06/05/laravel5-4%E6%95%B4%E5%90%88%E6%9E%81%E9%AA%8C%E9%AA%8C%E8%AF%81%E7%A0%813-0/</url>
      <content type="html"><![CDATA[<h2 id="注册账号"><a href="#注册账号" class="headerlink" title="注册账号"></a>注册账号</h2><p>注册地址:<a href="http://www.geetest.com/" target="_blank" rel="external">http://www.geetest.com/</a><br>注册之后获得最新的ID和KEY</p>
<h2 id="下载sdk"><a href="#下载sdk" class="headerlink" title="下载sdk"></a>下载sdk</h2><p>把下载下来的sdk改名为geetest放入vendor文件下<br>可以把geetest文件下的其他文件都删除只保留lib文件<br><a id="more"></a></p>
<h2 id="把lib下的class-geetestlib-php修改名称为：GeetestLib-class-ph-修改GeetestLib类里的pre-process-方法"><a href="#把lib下的class-geetestlib-php修改名称为：GeetestLib-class-ph-修改GeetestLib类里的pre-process-方法" class="headerlink" title="把lib下的class.geetestlib.php修改名称为：GeetestLib.class.ph 修改GeetestLib类里的pre_process()方法"></a>把lib下的class.geetestlib.php修改名称为：GeetestLib.class.ph 修改GeetestLib类里的pre_process()方法</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pre_process</span><span class="params">($param, $new_captcha=<span class="number">1</span>)</span> </span>&#123;</div><div class="line">        $data = <span class="keyword">array</span>(<span class="string">'gt'</span>=&gt;<span class="keyword">$this</span>-&gt;captcha_id,</div><div class="line">                     <span class="string">'new_captcha'</span>=&gt;$new_captcha</div><div class="line">                );</div><div class="line">        $data = array_merge($data,$param);<span class="comment">//没有修改的这里可能会报错</span></div><div class="line">        $query = http_build_query($data);</div><div class="line">        $url = <span class="string">"http://api.geetest.com/register.php?"</span> . $query;</div><div class="line">        $challenge = <span class="keyword">$this</span>-&gt;send_request($url);</div><div class="line">        <span class="keyword">if</span> (strlen($challenge) != <span class="number">32</span>) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;failback_process();</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">$this</span>-&gt;success_process($challenge);</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>改成<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pre_process</span><span class="params">($param, $new_captcha=<span class="number">1</span>)</span> </span>&#123;</div><div class="line">       $data = <span class="keyword">array</span>(<span class="string">'gt'</span>=&gt;<span class="keyword">$this</span>-&gt;captcha_id,</div><div class="line">                    <span class="string">'new_captcha'</span>=&gt;$new_captcha</div><div class="line">               );</div><div class="line">       <span class="keyword">if</span> (($param != <span class="keyword">null</span>) <span class="keyword">and</span> (is_string($param))) &#123;</div><div class="line">           $data[<span class="string">'user_id'</span>] = $param;</div><div class="line">       &#125;</div><div class="line">       $query = http_build_query($data);</div><div class="line">       $url = <span class="string">"http://api.geetest.com/register.php?"</span> . $query;</div><div class="line">       $challenge = <span class="keyword">$this</span>-&gt;send_request($url);</div><div class="line">       <span class="keyword">if</span> (strlen($challenge) != <span class="number">32</span>) &#123;</div><div class="line">           <span class="keyword">$this</span>-&gt;failback_process();</div><div class="line">           <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">$this</span>-&gt;success_process($challenge);</div><div class="line">       <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<h2 id="在composer-json的autoload内的classmap项新增类包"><a href="#在composer-json的autoload内的classmap项新增类包" class="headerlink" title="在composer.json的autoload内的classmap项新增类包,"></a>在composer.json的autoload内的classmap项新增类包,</h2><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">"autoload": &#123;</div><div class="line">       "classmap": [</div><div class="line">           "database",</div><div class="line">           "vendor/geetest"//添加自己的</div><div class="line">       ],</div><div class="line"></div><div class="line">       "psr-4": &#123;</div><div class="line">           "App\\": "app/"</div><div class="line">       &#125;</div><div class="line">   &#125;,</div></pre></td></tr></table></figure>
<h2 id="运行终端，cd到项目路径，使用composer命令"><a href="#运行终端，cd到项目路径，使用composer命令" class="headerlink" title="运行终端，cd到项目路径，使用composer命令"></a>运行终端，cd到项目路径，使用composer命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">composer dumpautoload</div></pre></td></tr></table></figure>
<p>然后就能在项目中愉快的使用GeetestLib类了，简单的用法如下：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">use</span> <span class="title">GeetestLib</span>;</div><div class="line">$GtSdk = <span class="keyword">new</span> GeetestLib()</div></pre></td></tr></table></figure></p>
<h2 id="我是在config文件下新建了sys-php做配置文件方便以后在后台修改"><a href="#我是在config文件下新建了sys-php做配置文件方便以后在后台修改" class="headerlink" title="我是在config文件下新建了sys.php做配置文件方便以后在后台修改"></a>我是在config文件下新建了sys.php做配置文件方便以后在后台修改</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*验证码配置*/</span></div><div class="line">   <span class="string">'GEE_ID'</span>  =&gt;  <span class="string">'4c65ff2cf2d4ac493e837a91215fff77'</span>,</div><div class="line">   <span class="string">'GEE_KEY'</span> =&gt;  <span class="string">'e9fc13ecf1178f6a59c80f8f42e5773f'</span>,</div></pre></td></tr></table></figure>
<h2 id="在App-Http-Controllers-下创建Geetest控制器方法getVerify"><a href="#在App-Http-Controllers-下创建Geetest控制器方法getVerify" class="headerlink" title="在App\Http\Controllers 下创建Geetest控制器方法getVerify()"></a>在App\Http\Controllers 下创建Geetest控制器方法getVerify()</h2> <figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">GeetestLib</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">GeetestController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getVerify</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="comment">//实例化并传入极验id与key值</span></div><div class="line">        $GtSdk = <span class="keyword">new</span> GeetestLib(config(<span class="string">'sys.GEE_ID'</span>), config(<span class="string">'sys.GEE_KEY'</span>));</div><div class="line">        $user_id = <span class="string">"web"</span>;</div><div class="line">        $status = $GtSdk-&gt;pre_process($user_id);</div><div class="line">        $data = <span class="keyword">array</span>(</div><div class="line">            <span class="string">'gtserver'</span>=&gt;$status,</div><div class="line">            <span class="string">'user_id'</span>=&gt;$user_id</div><div class="line">        );</div><div class="line">        session([<span class="string">'geetest'</span>=&gt;$data]);</div><div class="line"></div><div class="line">        <span class="keyword">echo</span> $GtSdk-&gt;get_response_str();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> 创建路由<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Route::get(&apos;/getVerify&apos;, &apos;GeetestController@getVerify&apos;)-&gt;name(&apos;getVerify&apos;);</div></pre></td></tr></table></figure></p>
<h2 id="在页面上处理"><a href="#在页面上处理" class="headerlink" title="在页面上处理"></a>在页面上处理</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div></pre></td><td class="code"><pre><div class="line">@extends('layouts.app')</div><div class="line"></div><div class="line">@section('content')</div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-8 col-md-offset-2"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">"form-horizontal"</span> <span class="attr">role</span>=<span class="string">"form"</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">action</span>=<span class="string">"&#123;&#123; route('login') &#125;&#125;"</span>&gt;</span></div><div class="line">                        &#123;&#123; csrf_field() &#125;&#125;</div><div class="line"></div><div class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group&#123;&#123; $errors-&gt;has('email') ? ' has-error' : '' &#125;&#125;"</span>&gt;</span></div><div class="line">                            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"email"</span> <span class="attr">class</span>=<span class="string">"col-md-4 control-label"</span>&gt;</span>E-Mail Address<span class="tag">&lt;/<span class="name">label</span>&gt;</span></div><div class="line"></div><div class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6"</span>&gt;</span></div><div class="line">                                <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"email"</span> <span class="attr">type</span>=<span class="string">"email"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">name</span>=<span class="string">"email"</span> <span class="attr">value</span>=<span class="string">"&#123;&#123; old('email') &#125;&#125;"</span> <span class="attr">required</span> <span class="attr">autofocus</span>&gt;</span></div><div class="line"></div><div class="line">                                @if ($errors-&gt;has('email'))</div><div class="line">                                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"help-block"</span>&gt;</span></div><div class="line">                                        <span class="tag">&lt;<span class="name">strong</span>&gt;</span>&#123;&#123; $errors-&gt;first('email') &#125;&#125;<span class="tag">&lt;/<span class="name">strong</span>&gt;</span></div><div class="line">                                    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">                                @endif</div><div class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"></div><div class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group&#123;&#123; $errors-&gt;has('password') ? ' has-error' : '' &#125;&#125;"</span>&gt;</span></div><div class="line">                            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"password"</span> <span class="attr">class</span>=<span class="string">"col-md-4 control-label"</span>&gt;</span>Password<span class="tag">&lt;/<span class="name">label</span>&gt;</span></div><div class="line"></div><div class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6"</span>&gt;</span></div><div class="line">                                <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"password"</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">required</span>&gt;</span></div><div class="line"></div><div class="line">                                @if ($errors-&gt;has('password'))</div><div class="line">                                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"help-block"</span>&gt;</span></div><div class="line">                                        <span class="tag">&lt;<span class="name">strong</span>&gt;</span>&#123;&#123; $errors-&gt;first('password') &#125;&#125;<span class="tag">&lt;/<span class="name">strong</span>&gt;</span></div><div class="line">                                    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">                                @endif</div><div class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"></div><div class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"embed-captcha"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"wait"</span> <span class="attr">class</span>=<span class="string">"show"</span>&gt;</span>正在加载验证码......<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"notice"</span> <span class="attr">class</span>=<span class="string">"hide"</span>&gt;</span>请先拖动验证码到相应位置<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></div><div class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6 col-md-offset-4"</span>&gt;</span></div><div class="line">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"checkbox"</span>&gt;</span></div><div class="line">                                    <span class="tag">&lt;<span class="name">label</span>&gt;</span></div><div class="line">                                        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">name</span>=<span class="string">"remember"</span> &#123;&#123; <span class="attr">old</span>('<span class="attr">remember</span>') ? '<span class="attr">checked</span>' <span class="attr">:</span> '' &#125;&#125;&gt;</span> Remember Me</div><div class="line">                                    <span class="tag">&lt;/<span class="name">label</span>&gt;</span></div><div class="line">                                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"></div><div class="line">                        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></div><div class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-8 col-md-offset-4"</span>&gt;</span></div><div class="line">                                <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">id</span>=<span class="string">"but"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span> <span class="attr">disabled</span>&gt;</span></div><div class="line">                                    Login</div><div class="line">                                <span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line"></div><div class="line">                                <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"btn btn-link"</span> <span class="attr">href</span>=<span class="string">"&#123;&#123; route('password.request') &#125;&#125;"</span>&gt;</span></div><div class="line">                                    Forgot Your Password?</div><div class="line">                                <span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">                        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">                    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://libs.baidu.com/jquery/1.9.0/jquery.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 引入封装了failback的接口--initGeetest --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://static.geetest.com/static/tools/gt.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></div><div class="line">        var handlerEmbed = function (captchaObj) &#123;</div><div class="line">            $("#embed-submit").click(function (e) &#123;</div><div class="line"></div><div class="line">                var validate = captchaObj.getValidate();</div><div class="line">                if (!validate) &#123;</div><div class="line">                    $("#notice")[0].className = "show";</div><div class="line">                    setTimeout(function () &#123;</div><div class="line">                        $("#notice")[0].className = "hide";</div><div class="line"></div><div class="line">                    &#125;, 2000);</div><div class="line">                    e.preventDefault();</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">            // 将验证码加到id为captcha的元素里</div><div class="line">            captchaObj.appendTo("#embed-captcha");</div><div class="line">            captchaObj.onReady(function () &#123;</div><div class="line">                $("#wait")[0].className = "hide";</div><div class="line">            &#125;);</div><div class="line">            //验证成功</div><div class="line">            captchaObj.onSuccess(function () &#123;</div><div class="line">                $("#but").attr("disabled",false)</div><div class="line">            &#125;);</div><div class="line">            //验证失败</div><div class="line">            captchaObj.onError(function () &#123;</div><div class="line">                $("#but").attr("disabled",true)</div><div class="line">            &#125;);</div><div class="line">            // 更多接口参考：http://www.geetest.com/install/sections/idx-client-sdk.html</div><div class="line">        &#125;;</div><div class="line">        $.ajax(&#123;</div><div class="line">            // 获取id，challenge，success（是否启用failback）</div><div class="line">            url: "&#123;&#123; route('getVerify',array('t'=&gt;time())) &#125;&#125;", // 加随机数防止缓存</div><div class="line">            type: "get",</div><div class="line">            dataType: "json",</div><div class="line">            success: function (data) &#123;</div><div class="line">                console.log(data)</div><div class="line">                // 使用initGeetest接口</div><div class="line">                // 参数1：配置参数</div><div class="line">                // 参数2：回调，回调的第一个参数验证码对象，之后可以使用它做appendTo之类的事件</div><div class="line">                initGeetest(&#123;</div><div class="line">                    gt: data.gt,</div><div class="line">                    challenge: data.challenge,</div><div class="line">                    product: "float", // 产品形式，包括：float，embed，popup。注意只对PC版验证码有效</div><div class="line">                    offline: !data.success // 表示用户后台检测极验服务器是否宕机，一般不需要关注</div><div class="line">                &#125;, handlerEmbed);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">@endsection</div></pre></td></tr></table></figure>
<h2 id="初始化完成之后的提交时前段会自动验证，然后提交给后台之后处理方法是："><a href="#初始化完成之后的提交时前段会自动验证，然后提交给后台之后处理方法是：" class="headerlink" title="初始化完成之后的提交时前段会自动验证，然后提交给后台之后处理方法是："></a>初始化完成之后的提交时前段会自动验证，然后提交给后台之后处理方法是：</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    $GtSdk = GeetestLib(config(<span class="string">'sys.GEE_ID'</span>), config(<span class="string">'sys.GEE_KEY'</span>));</div><div class="line">    $geetest = session(<span class="string">"geetest"</span>);</div><div class="line">    $user_id = $geetest[<span class="string">'user_id'</span>];);</div><div class="line">    <span class="keyword">if</span> ($geetest[<span class="string">'gtserver'</span>] == <span class="number">1</span>) &#123;</div><div class="line">        $result = $GtSdk-&gt;success_validate($geetest_challenge, $geetest_validate, $geetest_seccode, $user_id);</div><div class="line">        <span class="keyword">if</span> ($result) &#123;</div><div class="line">            <span class="keyword">echo</span> <span class="string">'Yes!'</span>;</div><div class="line">        &#125; <span class="keyword">else</span>&#123;</div><div class="line">            <span class="keyword">echo</span> <span class="string">'No'</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">       <span class="keyword">if</span> ($GtSdk-&gt;fail_validate($geetest_challenge, $geetest_validate, $geetest_seccode)) &#123;</div><div class="line">            <span class="keyword">echo</span> <span class="string">"yes"</span>;</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">            <span class="keyword">echo</span> <span class="string">"no"</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="然后在页面上就可以看到效果了。"><a href="#然后在页面上就可以看到效果了。" class="headerlink" title="然后在页面上就可以看到效果了。"></a>然后在页面上就可以看到效果了。</h2><p><img src="http://ac-HSNl7zbI.clouddn.com/5DW5lXOGECJCEtWTAmdFusPSXqMwUmA0jyLjRAar.jpg" alt=""></p>
]]></content>
      
        <categories>
            
            <category> php </category>
            
            <category> laravel </category>
            
        </categories>
        
        
        <tags>
            
            <tag> laravel </tag>
            
            <tag> geetest </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Centos初始化]]></title>
      <url>/2017/01/03/CentOS-1-3/</url>
      <content type="html"><![CDATA[<h2 id="换源"><a href="#换源" class="headerlink" title="换源"></a>换源</h2><h3 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup</div></pre></td></tr></table></figure>
<h3 id="写入国内源-centos-7"><a href="#写入国内源-centos-7" class="headerlink" title="写入国内源(centos 7)"></a>写入国内源(centos 7)</h3><p>ustc： <a href="https://lug.ustc.edu.cn/wiki/mirrors/help/centos" target="_blank" rel="external">https://lug.ustc.edu.cn/wiki/mirrors/help/centos</a></p>
<a id="more"></a>
<p>163：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"># CentOS-Base.repo</div><div class="line">#</div><div class="line"># The mirror system uses the connecting IP address of the client and the</div><div class="line"># update status of each mirror to pick mirrors that are updated to and</div><div class="line"># geographically close to the client.  You should use this for CentOS updates</div><div class="line"># unless you are manually picking other mirrors.</div><div class="line">#</div><div class="line"># If the mirrorlist= does not work for you, as a fall back you can try the</div><div class="line"># remarked out baseurl= line instead.</div><div class="line">#</div><div class="line">#</div><div class="line">[base]</div><div class="line">name=CentOS-$releasever - Base - 163.com</div><div class="line">#mirrorlist=http://mirrorlist.centos.org/?release=$releasever&amp;arch=$basearch&amp;repo=os</div><div class="line">baseurl=http://mirrors.163.com/centos/$releasever/os/$basearch/</div><div class="line">gpgcheck=1</div><div class="line">gpgkey=http://mirrors.163.com/centos/RPM-GPG-KEY-CentOS-7</div><div class="line"></div><div class="line">#released updates</div><div class="line">[updates]</div><div class="line">name=CentOS-$releasever - Updates - 163.com</div><div class="line">#mirrorlist=http://mirrorlist.centos.org/?release=$releasever&amp;arch=$basearch&amp;repo=updates</div><div class="line">baseurl=http://mirrors.163.com/centos/$releasever/updates/$basearch/</div><div class="line">gpgcheck=1</div><div class="line">gpgkey=http://mirrors.163.com/centos/RPM-GPG-KEY-CentOS-7</div><div class="line"></div><div class="line">#additional packages that may be useful</div><div class="line">[extras]</div><div class="line">name=CentOS-$releasever - Extras - 163.com</div><div class="line">#mirrorlist=http://mirrorlist.centos.org/?release=$releasever&amp;arch=$basearch&amp;repo=extras</div><div class="line">baseurl=http://mirrors.163.com/centos/$releasever/extras/$basearch/</div><div class="line">gpgcheck=1</div><div class="line">gpgkey=http://mirrors.163.com/centos/RPM-GPG-KEY-CentOS-7</div><div class="line"></div><div class="line">#additional packages that extend functionality of existing packages</div><div class="line">[centosplus]</div><div class="line">name=CentOS-$releasever - Plus - 163.com</div><div class="line">baseurl=http://mirrors.163.com/centos/$releasever/centosplus/$basearch/</div><div class="line">gpgcheck=1</div><div class="line">enabled=0</div><div class="line">gpgkey=http://mirrors.163.com/centos/RPM-GPG-KEY-CentOS-7</div></pre></td></tr></table></figure>
<h3 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum clean all</div><div class="line">yum makecache</div></pre></td></tr></table></figure>
<h2 id="设置代理"><a href="#设置代理" class="headerlink" title="设置代理"></a>设置代理</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#! /bin/bash</span></div><div class="line"><span class="comment"># Author: Kevin Tan</span></div><div class="line"><span class="comment"># Update-Date: 2017-1-14</span></div><div class="line">URL=<span class="variable">$1</span></div><div class="line">ACTION=(<span class="string">'\nSet'</span> <span class="string">'\nDel'</span>)</div><div class="line">mode=1</div><div class="line"><span class="keyword">if</span> [ -z <span class="variable">$URL</span> ]; <span class="keyword">then</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">'[Warning]: URL parameter is empty, default action change to remove'</span></div><div class="line">    mode=2</div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="function"><span class="title">set_proxy</span></span>()&#123;</div><div class="line">  file=<span class="variable">$1</span>;prefix=<span class="variable">$2</span>;value=<span class="string">"<span class="variable">$2</span>=<span class="variable">$3</span>"</span>;</div><div class="line">  <span class="built_in">echo</span> <span class="string">"Set \"<span class="variable">$value</span>\" to \"<span class="variable">$file</span>\""</span></div><div class="line">  <span class="keyword">if</span> [ -e <span class="string">"<span class="variable">$file</span>"</span> ]; <span class="keyword">then</span></div><div class="line">    <span class="keyword">if</span> grep -q <span class="string">"^\s*<span class="variable">$prefix</span>"</span> <span class="string">"<span class="variable">$file</span>"</span>; <span class="keyword">then</span></div><div class="line">        sed -i <span class="string">"s#^\s*<span class="variable">$prefix</span>=.*#<span class="variable">$value</span>#g"</span> <span class="variable">$file</span></div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="built_in">echo</span> <span class="variable">$value</span> &gt;&gt; <span class="variable">$file</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line">  <span class="keyword">fi</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="title">del_proxy</span></span>()&#123;</div><div class="line">    file=<span class="variable">$1</span>;prefix=<span class="variable">$2</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"Del \"<span class="variable">$prefix</span>\" from \"<span class="variable">$file</span>\""</span></div><div class="line">    <span class="keyword">if</span> [ -e <span class="string">"<span class="variable">$file</span>"</span> ]; <span class="keyword">then</span></div><div class="line">        sed -i <span class="string">"/^\s*<span class="variable">$prefix</span>=.*/d"</span> <span class="variable">$file</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line">    <span class="built_in">eval</span> <span class="variable">$prefix</span>=<span class="string">""</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">SHELL_NAME=`ps -p $$ | awk <span class="string">'NR==2 &#123;print $4&#125;'</span>`</div><div class="line"><span class="built_in">echo</span> <span class="string">'Current shell is '</span><span class="variable">$SHELL_NAME</span></div><div class="line"><span class="function"><span class="title">source_file</span></span>()&#123;</div><div class="line">    <span class="comment">## bash</span></div><div class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$SHELL_NAME</span>"</span> = <span class="string">"bash"</span> ]; <span class="keyword">then</span></div><div class="line">        <span class="built_in">source</span> <span class="variable">$HOME</span><span class="string">'/.bashrc'</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line">    <span class="comment">## zsh</span></div><div class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$SHELL_NAME</span>"</span> = <span class="string">"zsh"</span> ]; <span class="keyword">then</span></div><div class="line">        <span class="built_in">source</span> <span class="variable">$HOME</span><span class="string">'/.zshrc'</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"># yum</span></div><div class="line"><span class="built_in">echo</span> -n <span class="variable">$&#123;ACTION[$mode]&#125;</span><span class="string">' the yum? (y/n/r) '</span>;<span class="built_in">read</span> F</div><div class="line"><span class="keyword">if</span> [ <span class="variable">$F</span> = <span class="string">'y'</span> ] &amp;&amp; [ <span class="variable">$mode</span> -eq 1 ]; <span class="keyword">then</span></div><div class="line">    set_proxy <span class="string">'/etc/yum.conf'</span> <span class="string">'proxy'</span> <span class="variable">$URL</span></div><div class="line"><span class="keyword">elif</span> [ <span class="variable">$F</span> = <span class="string">'r'</span> ] || ([ <span class="variable">$F</span> = <span class="string">'y'</span> ] &amp;&amp; [ <span class="variable">$mode</span> -eq 2 ]); <span class="keyword">then</span></div><div class="line">    del_proxy <span class="string">'/etc/yum.conf'</span> <span class="string">'proxy'</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="comment"># environment</span></div><div class="line"><span class="built_in">echo</span> -n <span class="variable">$&#123;ACTION[$mode]&#125;</span><span class="string">' the environment var?(y/n/r) '</span>;<span class="built_in">read</span> F</div><div class="line">shell_names=(zsh bash)</div><div class="line"><span class="keyword">if</span> [ <span class="variable">$F</span> = <span class="string">'y'</span> ] &amp;&amp; [ <span class="variable">$mode</span> -eq 1 ]; <span class="keyword">then</span></div><div class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> <span class="variable">$&#123;shell_names[@]&#125;</span>; <span class="keyword">do</span></div><div class="line">        set_proxy <span class="string">"<span class="variable">$HOME</span>/.<span class="variable">$&#123;name&#125;</span>rc"</span> <span class="string">"export http_proxy"</span> <span class="variable">$URL</span></div><div class="line">        set_proxy <span class="string">"<span class="variable">$HOME</span>/.<span class="variable">$&#123;name&#125;</span>rc"</span> <span class="string">"export https_proxy"</span> <span class="variable">$URL</span></div><div class="line">    <span class="keyword">done</span></div><div class="line">    source_file</div><div class="line"><span class="keyword">elif</span> [ <span class="variable">$F</span> = <span class="string">'r'</span> ] || ([ <span class="variable">$F</span> = <span class="string">'y'</span> ] &amp;&amp; [ <span class="variable">$mode</span> -eq 2 ]); <span class="keyword">then</span></div><div class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> <span class="variable">$&#123;shell_names[@]&#125;</span>; <span class="keyword">do</span></div><div class="line">        del_proxy <span class="string">"<span class="variable">$HOME</span>/.<span class="variable">$&#123;name&#125;</span>rc"</span> <span class="string">"export http_proxy"</span></div><div class="line">        del_proxy <span class="string">"<span class="variable">$HOME</span>/.<span class="variable">$&#123;name&#125;</span>rc"</span> <span class="string">"export https_proxy"</span></div><div class="line">    <span class="keyword">done</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="comment">#curl</span></div><div class="line"><span class="built_in">echo</span> -n <span class="variable">$&#123;ACTION[$mode]&#125;</span><span class="string">' the curl proxy alias?(y/n/r) '</span>;<span class="built_in">read</span> F</div><div class="line">shell_names=(zsh bash)</div><div class="line"><span class="keyword">if</span> [ <span class="variable">$F</span> = <span class="string">'y'</span> ] &amp;&amp; [ <span class="variable">$mode</span> -eq 1 ]; <span class="keyword">then</span></div><div class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> <span class="variable">$&#123;shell_names[@]&#125;</span>; <span class="keyword">do</span></div><div class="line">    	set_proxy <span class="string">"<span class="variable">$HOME</span>/.<span class="variable">$&#123;name&#125;</span>rc"</span> <span class="string">"alias curl"</span> <span class="string">"\"curl -x <span class="variable">$URL</span>\""</span>   </div><div class="line">    <span class="keyword">done</span></div><div class="line">    source_file</div><div class="line"><span class="keyword">elif</span> [ <span class="variable">$F</span> = <span class="string">'r'</span> ] || ([ <span class="variable">$F</span> = <span class="string">'y'</span> ] &amp;&amp; [ <span class="variable">$mode</span> -eq 2 ]); <span class="keyword">then</span></div><div class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> <span class="variable">$&#123;shell_names[@]&#125;</span>; <span class="keyword">do</span></div><div class="line">        del_proxy <span class="string">"<span class="variable">$HOME</span>/.<span class="variable">$&#123;name&#125;</span>rc"</span> <span class="string">"alias curl"</span></div><div class="line">        <span class="built_in">unalias</span> curl</div><div class="line">    <span class="keyword">done</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="comment"># kubernetes</span></div><div class="line"><span class="built_in">echo</span> -n <span class="variable">$&#123;ACTION[$mode]&#125;</span><span class="string">' kube environment var?(y/n/r) '</span>;<span class="built_in">read</span> F</div><div class="line"><span class="keyword">if</span> [ <span class="variable">$F</span> = <span class="string">'y'</span> ] &amp;&amp; [ <span class="variable">$mode</span> -eq 1 ]; <span class="keyword">then</span></div><div class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> <span class="variable">$&#123;shell_names[@]&#125;</span>; <span class="keyword">do</span></div><div class="line">        set_proxy <span class="string">"<span class="variable">$HOME</span>/.<span class="variable">$&#123;name&#125;</span>rc"</span> <span class="string">"export KUBERNETES_HTTP_PROXY"</span> <span class="variable">$URL</span></div><div class="line">        set_proxy <span class="string">"<span class="variable">$HOME</span>/.<span class="variable">$&#123;name&#125;</span>rc"</span> <span class="string">"export KUBERNETES_HTTPS_PROXY"</span> <span class="variable">$URL</span></div><div class="line">        set_proxy <span class="string">"<span class="variable">$HOME</span>/.<span class="variable">$&#123;name&#125;</span>rc"</span> <span class="string">"export KUBE_BUILD_HTTPS_PROXY"</span> <span class="variable">$URL</span></div><div class="line">        set_proxy <span class="string">"<span class="variable">$HOME</span>/.<span class="variable">$&#123;name&#125;</span>rc"</span> <span class="string">"export KUBE_BUILD_HTTP_PROXY"</span> <span class="variable">$URL</span></div><div class="line">    <span class="keyword">done</span></div><div class="line">    source_file</div><div class="line"><span class="keyword">elif</span> [ <span class="variable">$F</span> = <span class="string">'r'</span> ] || ([ <span class="variable">$F</span> = <span class="string">'y'</span> ] &amp;&amp; [ <span class="variable">$mode</span> -eq 2 ]); <span class="keyword">then</span></div><div class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> <span class="variable">$&#123;shell_names[@]&#125;</span>; <span class="keyword">do</span></div><div class="line">        del_proxy <span class="string">"<span class="variable">$HOME</span>/.<span class="variable">$&#123;name&#125;</span>rc"</span> <span class="string">"export KUBERNETES_HTTP_PROXY"</span></div><div class="line">        del_proxy <span class="string">"<span class="variable">$HOME</span>/.<span class="variable">$&#123;name&#125;</span>rc"</span> <span class="string">"export KUBERNETES_HTTPS_PROXY"</span></div><div class="line">        del_proxy <span class="string">"<span class="variable">$HOME</span>/.<span class="variable">$&#123;name&#125;</span>rc"</span> <span class="string">"export KUBE_BUILD_HTTPS_PROXY"</span></div><div class="line">        del_proxy <span class="string">"<span class="variable">$HOME</span>/.<span class="variable">$&#123;name&#125;</span>rc"</span> <span class="string">"export KUBE_BUILD_HTTP_PROXY"</span></div><div class="line">    <span class="keyword">done</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="comment"># docker</span></div><div class="line"><span class="built_in">echo</span> -n <span class="variable">$&#123;ACTION[$mode]&#125;</span><span class="string">' the docker?(y/n/r) '</span>;<span class="built_in">read</span> F</div><div class="line"><span class="keyword">if</span> <span class="built_in">type</span> <span class="string">"docker"</span> &amp;&gt;/dev/null &amp;&amp; ([ <span class="variable">$F</span> = <span class="string">'y'</span> ] || [ <span class="variable">$F</span> = <span class="string">'r'</span> ]); <span class="keyword">then</span></div><div class="line">        DOCKER_CONF_DIR=<span class="string">'/etc/systemd/system/docker.service.d'</span></div><div class="line">        DOCKER_CONF=<span class="variable">$DOCKER_CONF_DIR</span><span class="string">'/http-proxy.conf'</span></div><div class="line">        REGISTRY=<span class="string">"87129800.m.daodocker.io"</span></div><div class="line">        sudo mkdir -p <span class="string">"<span class="variable">$DOCKER_CONF_DIR</span>"</span></div><div class="line">        sudo rm -rf <span class="variable">$DOCKER_CONF</span></div><div class="line">        <span class="keyword">if</span> [ <span class="variable">$F</span> = <span class="string">'y'</span> ] &amp;&amp; [ <span class="variable">$mode</span> -eq 1 ]; <span class="keyword">then</span></div><div class="line">            <span class="built_in">printf</span> <span class="string">"[Service]\nEnvironment="</span> | sudo tee <span class="variable">$DOCKER_CONF</span> &gt; /dev/null</div><div class="line">            <span class="built_in">printf</span> <span class="string">"\"HTTP_PROXY=%s\" "</span> <span class="variable">$URL</span> | sudo tee -a <span class="variable">$DOCKER_CONF</span> &gt; /dev/null</div><div class="line">            <span class="built_in">printf</span> <span class="string">"\"HTTPS_PROXY=%s\" "</span> <span class="variable">$URL</span> | sudo tee -a <span class="variable">$DOCKER_CONF</span> &gt; /dev/null</div><div class="line">            <span class="built_in">printf</span> <span class="string">"\"NO_PROXY=localhost,%s\""</span> <span class="variable">$REGISTRY</span> | sudo tee -a <span class="variable">$DOCKER_CONF</span> &gt; /dev/null</div><div class="line">        <span class="keyword">fi</span></div><div class="line">        sudo systemctl daemon-reload</div><div class="line">        sudo systemctl restart docker</div><div class="line">        <span class="built_in">echo</span> <span class="string">"Daemon reloaded"</span></div><div class="line">        systemctl show --property=Environment docker</div><div class="line"><span class="keyword">fi</span></div></pre></td></tr></table></figure>
<p>将上面脚本保持为setproxy，然后执行,注意，如果当前环境下已经有了http_proxy等变量。则需要我们手动reset</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">chmod u+x setproxy</div><div class="line"><span class="built_in">source</span> setproxy http://10.100.100.136:4411</div></pre></td></tr></table></figure>
<h2 id="基础建设"><a href="#基础建设" class="headerlink" title="基础建设"></a>基础建设</h2><h3 id="git-amp-amp-gcc"><a href="#git-amp-amp-gcc" class="headerlink" title="git &amp;&amp; gcc"></a>git &amp;&amp; gcc</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install git gcc</div></pre></td></tr></table></figure>
<h3 id="pip"><a href="#pip" class="headerlink" title="pip"></a>pip</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl <span class="string">"https://bootstrap.pypa.io/get-pip.py"</span> | python</div></pre></td></tr></table></figure>
<p>EPEL</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rpm -ivh http://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm</div></pre></td></tr></table></figure>
<h2 id="ZSH"><a href="#ZSH" class="headerlink" title="ZSH"></a>ZSH</h2><h3 id="安装-amp-激活"><a href="#安装-amp-激活" class="headerlink" title="安装 &amp; 激活"></a>安装 &amp; 激活</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum install zsh</div><div class="line">chsh -s /bin/zsh</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Linux </category>
            
        </categories>
        
        
        <tags>
            
            <tag> centos </tag>
            
        </tags>
        
    </entry>
    
  
  
</search>
